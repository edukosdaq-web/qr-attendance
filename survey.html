<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>êµìœ¡ë§Œì¡±ë„ ì„¤ë¬¸ì¡°ì‚¬ - ì½”ìŠ¤ë‹¥í˜‘íšŒ</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
    background: #f5f7fa; 
    color: #333; 
    line-height: 1.6; 
    padding: 20px 0; 
}
.container { 
    max-width: 600px; 
    margin: 0 auto; 
    padding: 0 16px; 
}
.header {
    text-align: center;
    margin-bottom: 32px;
    padding: 24px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.logo { 
    font-size: 14px; 
    color: #666; 
    margin-bottom: 8px; 
}
.title { 
    font-size: 24px; 
    font-weight: 700; 
    color: #1a365d; 
    margin-bottom: 16px; 
}
.participant-info {
    background: #e6f3ff;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 12px;
    font-size: 14px;
}
.privacy-notice {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 12px;
    font-size: 12px;
    color: #856404;
    text-align: center;
}

.section {
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.section-title {
    font-size: 18px;
    font-weight: 700;
    color: #1a365d;
    margin-bottom: 20px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e2e8f0;
}
.question {
    margin-bottom: 24px;
}
.question:last-child { margin-bottom: 0; }
.question-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 12px;
    color: #2d3748;
}
.required { color: #e53e3e; }

.radio-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.radio-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    background: #f8f9fa;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}
.radio-item:hover {
    background: #e6f3ff;
    border-color: #3182ce;
}
.radio-item input[type="radio"] {
    margin-right: 8px;
    width: 16px;
    height: 16px;
}
.radio-item.checked {
    background: #e6f3ff;
    border-color: #3182ce;
}

.scale-group {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px;
    margin-bottom: 8px;
}
.scale-item {
    text-align: center;
    padding: 12px 8px;
    background: #f8f9fa;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}
.scale-item:hover {
    background: #e6f3ff;
    border-color: #3182ce;
}
.scale-item.selected {
    background: #3182ce;
    border-color: #3182ce;
    color: #fff;
}
.scale-item input[type="radio"] {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    margin: 0;
    cursor: pointer;
}
.scale-labels {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #666;
    margin-top: 8px;
}

.text-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    resize: vertical;
    min-height: 80px;
}
.text-input:focus {
    outline: none;
    border-color: #3182ce;
    box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
}
.char-count {
    text-align: right;
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}

.submit-section {
    text-align: center;
    padding: 32px 24px;
}
.submit-btn {
    background: #3182ce;
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    padding: 16px 48px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: background 0.2s;
    min-width: 200px;
}
.submit-btn:hover:not(:disabled) {
    background: #2c5282;
}
.submit-btn:disabled {
    background: #cbd5e0;
    cursor: not-allowed;
}

.complete-section {
    text-align: center;
    padding: 40px 24px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.complete-icon { font-size: 48px; margin-bottom: 16px; }
.complete-title {
    font-size: 20px;
    font-weight: 700;
    color: #38a169;
    margin-bottom: 12px;
}
.complete-message {
    color: #666;
    margin-bottom: 24px;
}
.back-btn {
    display: inline-block;
    background: #f7fafc;
    color: #3182ce;
    font-size: 14px;
    font-weight: 500;
    padding: 12px 24px;
    border: 1px solid #cbd5e0;
    border-radius: 8px;
    text-decoration: none;
    cursor: pointer;
}

.error-section {
    text-align: center;
    padding: 40px 24px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.error-icon { font-size: 48px; margin-bottom: 16px; }
.error-title {
    font-size: 20px;
    font-weight: 700;
    color: #e53e3e;
    margin-bottom: 12px;
}
.error-message {
    color: #666;
    margin-bottom: 24px;
}

.loading {
    text-align: center;
    padding: 40px;
}
.spinner {
    display: inline-block;
    width: 32px;
    height: 32px;
    border: 3px solid #e2e8f0;
    border-radius: 50%;
    border-top-color: #3182ce;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

.conditional-section {
    display: none;
}
.conditional-section.show {
    display: block;
}

@media (max-width: 768px) {
    .scale-group {
        grid-template-columns: repeat(5, 1fr);
        gap: 4px;
    }
    .scale-item {
        padding: 8px 4px;
        font-size: 14px;
    }
    .section {
        padding: 20px;
    }
}
</style>
</head>
<body>
    <div class="container">
        <div id="app">
            <div class="loading">
                <div class="spinner"></div>
                <div>ì„¤ë¬¸ì¡°ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbz5sEyjgPzbzSGEQl9q3tI2_wJv5zX5YuAYkXpLM8ThsF3yJS6FaksEVl0CCl7R3dFP/exec';
        const params = new URLSearchParams(location.search);
        const token = params.get('token');
        const app = document.getElementById('app');

        let surveyData = null;
        let answers = {};

        // ì´ˆê¸° ë¡œë“œ
        if (!token) {
            showError('QR í† í°ì´ ì—†ìŠµë‹ˆë‹¤', 'ë¬¸ìì—ì„œ ë§í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
        } else {
            loadSurvey();
        }

        async function loadSurvey() {
            try {
                const response = await fetch(`${API_URL}?action=getSurveyForParticipant&token=${encodeURIComponent(token)}`);
                const result = await response.json();
                
                if (result.status === 'ok') {
                    surveyData = result.data;
                    if (surveyData.alreadySubmitted) {
                        showAlreadySubmitted();
                    } else {
                        renderSurvey();
                    }
                } else {
                    showError('ì˜¤ë¥˜ ë°œìƒ', result.message || 'ì„¤ë¬¸ì¡°ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                showError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜', 'ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        function renderSurvey() {
            const subjects = surveyData.subjects || [];
            
            app.innerHTML = `
                <div class="header">
                    <div class="logo">ì½”ìŠ¤ë‹¥í˜‘íšŒ</div>
                    <div class="title">êµìœ¡ë§Œì¡±ë„ ì„¤ë¬¸ì¡°ì‚¬</div>
                    <div class="participant-info">
                        <strong>${escapeHtml(surveyData.name)}</strong> (${escapeHtml(surveyData.company)})<br>
                        ì—°ìˆ˜ëª…: ${escapeHtml(surveyData.trainingName)}
                    </div>
                    <div class="privacy-notice">
                        âš¡ ì„¤ë¬¸ ì‹œ ì…ë ¥í•˜ì‹  ì •ë³´ëŠ” ì¶œì„ í™•ì¸ í›„ ì•”í˜¸í™” ì²˜ë¦¬ë˜ì–´ ì„¤ë¬¸ ì‘ë‹µìëŠ” í™•ì¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">ê¸°ë³¸ ì •ë³´</div>
                    
                    <div class="question">
                        <div class="question-title">Q1. ê³µì‹œë‹´ë‹¹ìë¡œ ê·¼ë¬´í•˜ì‹ ì§€ ì–¼ë§ˆë‚˜ ë˜ì…¨ìŠµë‹ˆê¹Œ? <span class="required">*</span></div>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="q1" value="1ë…„ ë¯¸ë§Œ" onchange="updateAnswer('q1', this.value)">
                                1ë…„ ë¯¸ë§Œ
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q1" value="1ë…„ ì´ìƒ ~ 3ë…„ ë¯¸ë§Œ" onchange="updateAnswer('q1', this.value)">
                                1ë…„ ì´ìƒ ~ 3ë…„ ë¯¸ë§Œ
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q1" value="3ë…„ ì´ìƒ ~ 5ë…„ ë¯¸ë§Œ" onchange="updateAnswer('q1', this.value)">
                                3ë…„ ì´ìƒ ~ 5ë…„ ë¯¸ë§Œ
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q1" value="5ë…„ ì´ìƒ ~ 10ë…„ ë¯¸ë§Œ" onchange="updateAnswer('q1', this.value)">
                                5ë…„ ì´ìƒ ~ 10ë…„ ë¯¸ë§Œ
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q1" value="10ë…„ ì´ìƒ" onchange="updateAnswer('q1', this.value)">
                                10ë…„ ì´ìƒ
                            </label>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">Q2. ë³¸ êµìœ¡ ìˆ˜ê°• ì „, ê³µì‹œì™€ ê´€ë ¨í•œ ë³¸ì¸ì˜ ì—…ë¬´ ìˆ˜í–‰ ëŠ¥ë ¥ì„ ì–´ë–»ê²Œ í‰ê°€í•˜ì‹­ë‹ˆê¹Œ? <span class="required">*</span></div>
                        <div class="scale-group" id="q2-scale">
                            <div class="scale-item" onclick="selectScale('q2', 1)">
                                <input type="radio" name="q2" value="1">
                                <div>1</div>
                            </div>
                            <div class="scale-item" onclick="selectScale('q2', 2)">
                                <input type="radio" name="q2" value="2">
                                <div>2</div>
                            </div>
                            <div class="scale-item" onclick="selectScale('q2', 3)">
                                <input type="radio" name="q2" value="3">
                                <div>3</div>
                            </div>
                            <div class="scale-item" onclick="selectScale('q2', 4)">
                                <input type="radio" name="q2" value="4">
                                <div>4</div>
                            </div>
                            <div class="scale-item" onclick="selectScale('q2', 5)">
                                <input type="radio" name="q2" value="5">
                                <div>5</div>
                            </div>
                        </div>
                        <div class="scale-labels">
                            <span>ë§¤ìš° ë‚®ë‹¤</span>
                            <span>ë§¤ìš° ë†’ë‹¤</span>
                        </div>
                    </div>

                    <div class="question">
                        <div class="question-title">Q3. ë³¸ êµìœ¡ì—ì„œ ê°€ì¥ ê¸°ëŒ€í–ˆë˜ ê²ƒì€ ë¬´ì—‡ì…ë‹ˆê¹Œ? <span class="required">*</span></div>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="q3" value="ê³µì‹œ ì—…ë¬´ì— ëŒ€í•œ ì „ë°˜ì  ì´í•´ë„ í–¥ìƒ" onchange="updateAnswer('q3', this.value); toggleQ3Other(false)">
                                ê³µì‹œ ì—…ë¬´ì— ëŒ€í•œ ì „ë°˜ì  ì´í•´ë„ í–¥ìƒ
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q3" value="ìµœì‹  ì´ìŠˆ ë° ì‚¬ë¡€ ìŠµë“ì„ í†µí•œ ì‹¤ë¬´ ëŠ¥ë ¥ í–¥ìƒ" onchange="updateAnswer('q3', this.value); toggleQ3Other(false)">
                                ìµœì‹  ì´ìŠˆ ë° ì‚¬ë¡€ ìŠµë“ì„ í†µí•œ ì‹¤ë¬´ ëŠ¥ë ¥ í–¥ìƒ
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q3" value="í‰ì†Œ ì—…ë¬´ ì¤‘ í—·ê°ˆë¦¬ê±°ë‚˜ ê¶ê¸ˆí–ˆë˜ ì‚¬í•­ í•´ì†Œ" onchange="updateAnswer('q3', this.value); toggleQ3Other(false)">
                                í‰ì†Œ ì—…ë¬´ ì¤‘ í—·ê°ˆë¦¬ê±°ë‚˜ ê¶ê¸ˆí–ˆë˜ ì‚¬í•­ í•´ì†Œ
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q3" value="ì—…ë¬´ì— í•„ìš”í•œ ì£¼ìš” ì¼ì • ë° ì°¸ê³  ìë£Œ í™•ì¸" onchange="updateAnswer('q3', this.value); toggleQ3Other(false)">
                                ì—…ë¬´ì— í•„ìš”í•œ ì£¼ìš” ì¼ì • ë° ì°¸ê³  ìë£Œ í™•ì¸
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q3" value="ê¸°íƒ€" onchange="updateAnswer('q3', 'ê¸°íƒ€'); toggleQ3Other(true)">
                                ê¸°íƒ€
                            </label>
                        </div>
                        <div id="q3-other" style="display: none; margin-top: 12px;">
                            <textarea class="text-input" placeholder="ê¸°íƒ€ ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" maxlength="200" onchange="updateAnswer('q3_text', this.value)" oninput="updateCharCount('q3-other-count', this.value, 200)"></textarea>
                            <div class="char-count"><span id="q3-other-count">0</span>/200</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-title">êµìœ¡ ë§Œì¡±ë„</div>
                    
                    <div class="question">
                        <div class="question-title">Q4. êµìœ¡ì— ì–¼ë§ˆë‚˜ ë§Œì¡±í•˜ì‹­ë‹ˆê¹Œ? <span class="required">*</span></div>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="q4" value="ë§¤ìš° ë§Œì¡±" onchange="updateAnswer('q4', this.value); toggleQ4Branch('satisfied')">
                                ë§¤ìš° ë§Œì¡±
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q4" value="ë§Œì¡±" onchange="updateAnswer('q4', this.value); toggleQ4Branch('satisfied')">
                                ë§Œì¡±
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q4" value="ë¶ˆë§Œì¡±" onchange="updateAnswer('q4', this.value); toggleQ4Branch('dissatisfied')">
                                ë¶ˆë§Œì¡±
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q4" value="ë§¤ìš° ë¶ˆë§Œì¡±" onchange="updateAnswer('q4', this.value); toggleQ4Branch('dissatisfied')">
                                ë§¤ìš° ë¶ˆë§Œì¡±
                            </label>
                        </div>
                    </div>

                    <div class="question conditional-section" id="q5-section">
                        <div class="question-title">Q5. êµìœ¡ì— ë§Œì¡±í•˜ì…¨ë‹¤ë©´, ì–´ë–¤ ì ì´ ë§Œì¡±ìŠ¤ëŸ¬ìš°ì…¨ìŠµë‹ˆê¹Œ? <span class="required">*</span></div>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="q5" value="êµìœ¡ ì»¤ë¦¬í˜ëŸ¼" onchange="updateAnswer('q5', this.value)">
                                êµìœ¡ ì»¤ë¦¬í˜ëŸ¼ (êµìœ¡ì˜ í¬ê´„ì„±, í¸ì„±ì˜ ì²´ê³„ì„±, êµìœ¡ ì¼ì •ì˜ ì ì ˆì„± ë“±)
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q5" value="ì‚¬ë¡€ ë° ì‹¤ë¬´ ì¤‘ì‹¬ êµìœ¡" onchange="updateAnswer('q5', this.value)">
                                ì‚¬ë¡€ ë° ì‹¤ë¬´ ì¤‘ì‹¬ êµìœ¡ (ìµœì‹  ì‚¬ë¡€ ë°˜ì˜, ì‹¤ë¬´ì—ì„œ í‹€ë¦¬ê¸° ì‰¬ìš´ ë¶€ë¶„ì„ ì¡ì•„ì¤Œ ë“±)
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q5" value="ê°•ì‚¬ì˜ ì „ë¬¸ì„± ë° ê°•ì˜ë ¥" onchange="updateAnswer('q5', this.value)">
                                ê°•ì‚¬ì˜ ì „ë¬¸ì„± ë° ê°•ì˜ë ¥ (ê°•ì‚¬ì˜ ë…¸í•˜ìš°, ì´í•´í•˜ê¸° ì‰½ê³  ìƒì„¸í•œ ì„¤ëª… ë“±)
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q5" value="êµìœ¡ ë°©ë²•" onchange="updateAnswer('q5', this.value)">
                                êµìœ¡ ë°©ë²• (ì´ë¡ ê³¼ ì‹¤ë¬´ì˜ ì•ˆë°° ë“±)
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q5" value="ì—°ìˆ˜ ìˆ˜ê°• í™˜ê²½" onchange="updateAnswer('q5', this.value)">
                                ì—°ìˆ˜ ìˆ˜ê°• í™˜ê²½ (ì—°ìˆ˜ì¥ ë˜ëŠ” ì‹ë‹¹ ë“±)
                            </label>
                        </div>
                    </div>

                    <div class="question conditional-section" id="q6-section">
                        <div class="question-title">Q6. êµìœ¡ì— ë¶ˆë§Œì¡±í•˜ì…¨ë‹¤ë©´, ì–´ë–¤ ì ì— ëŒ€í•œ ê°œì„ ì´ í•„ìš”í•˜ë‹¤ê³  ìƒê°í•˜ì‹­ë‹ˆê¹Œ? <span class="required">*</span></div>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="q6" value="êµìœ¡ ì»¤ë¦¬í˜ëŸ¼" onchange="updateAnswer('q6', this.value)">
                                êµìœ¡ ì»¤ë¦¬í˜ëŸ¼ (ê°•ì‚¬ ê°„ êµìœ¡ ë‚´ìš©ì´ ê²¹ì¹¨, ê³¼ëª©ì´ ì ê±°ë‚˜ ë§ìŒ, ì¼ì • ë“±)
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q6" value="ì‚¬ë¡€ ë³´ê°• ë“± ì‹¤ë¬´ ë‚´ìš©" onchange="updateAnswer('q6', this.value)">
                                ì‚¬ë¡€ ë³´ê°• ë“± ì‹¤ë¬´ ë‚´ìš© ë” í•„ìš”
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q6" value="ê°•ì‚¬ì˜ ê°•ì˜ë ¥" onchange="updateAnswer('q6', this.value)">
                                ê°•ì‚¬ì˜ ê°•ì˜ë ¥ (ë™ê¸°ìœ ë°œ, ì „ë‹¬ë ¥, ì†Œí†µ ëŠ¥ë ¥ ë“±)
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q6" value="êµìœ¡ ë°©ë²•" onchange="updateAnswer('q6', this.value)">
                                êµìœ¡ ë°©ë²• (ì´ë¡ ê³¼ ì‹¤ë¬´ì˜ ì•ˆë°° ë“±)
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="q6" value="ì—°ìˆ˜ ìˆ˜ê°• í™˜ê²½" onchange="updateAnswer('q6', this.value)">
                                ì—°ìˆ˜ ìˆ˜ê°• í™˜ê²½ (ì—°ìˆ˜ì¥, ì‹ë‹¹ ë“±)
                            </label>
                        </div>
                    </div>
                </div>

                ${subjects.length > 0 ? `
                <div class="section">
                    <div class="section-title">ê³¼ëª©ë³„ ë§Œì¡±ë„ í‰ê°€</div>
                    ${subjects.map((subject, index) => `
                        <div class="question">
                            <div class="question-title">${escapeHtml(subject.name)} - ${escapeHtml(subject.instructor)} <span class="required">*</span></div>
                            <div class="scale-group" id="subject-${index}-scale">
                                <div class="scale-item" onclick="selectScale('subject_${index}', 1)">
                                    <input type="radio" name="subject_${index}" value="1">
                                    <div>1</div>
                                </div>
                                <div class="scale-item" onclick="selectScale('subject_${index}', 2)">
                                    <input type="radio" name="subject_${index}" value="2">
                                    <div>2</div>
                                </div>
                                <div class="scale-item" onclick="selectScale('subject_${index}', 3)">
                                    <input type="radio" name="subject_${index}" value="3">
                                    <div>3</div>
                                </div>
                                <div class="scale-item" onclick="selectScale('subject_${index}', 4)">
                                    <input type="radio" name="subject_${index}" value="4">
                                    <div>4</div>
                                </div>
                                <div class="scale-item" onclick="selectScale('subject_${index}', 5)">
                                    <input type="radio" name="subject_${index}" value="5">
                                    <div>5</div>
                                </div>
                            </div>
                            <div class="scale-labels">
                                <span>ë§¤ìš° ë¶ˆë§Œì¡±</span>
                                <span>ë§¤ìš° ë§Œì¡±</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ` : ''}

                <div class="section">
                    <div class="section-title">ì¢…í•© ì˜ê²¬</div>
                    
                    <div class="question">
                        <div class="question-title">íŠ¹íˆ ì¸ìƒì ì´ì—ˆê±°ë‚˜ ê°œì„ ì´ í•„ìš”í•œ ê³¼ëª©ì´ ìˆì—ˆë‹¤ë©´ ê°„ë‹¨íˆ ì˜ê²¬ì„ ê¸°ìˆ í•´ ì£¼ì„¸ìš”.</div>
                        <textarea class="text-input" placeholder="ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì„ íƒì‚¬í•­)" maxlength="1000" onchange="updateAnswer('text1', this.value)" oninput="updateCharCount('text1-count', this.value, 1000)"></textarea>
                        <div class="char-count"><span id="text1-count">0</span>/1000</div>
                    </div>

                    <div class="question">
                        <div class="question-title">í–¥í›„ ë” ë‚˜ì€ êµìœ¡ì„ ìœ„í•˜ì—¬ ë³¸íšŒì— ìš”ì²­í•˜ê±°ë‚˜ ê°œì„ í•  ì ì´ ìˆë‹¤ë©´ ê¸°ì¬í•´ ì£¼ì„¸ìš”. <span class="required">*</span></div>
                        <textarea class="text-input" placeholder="ê°œì„ ì ì„ êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”" maxlength="1000" onchange="updateAnswer('text2', this.value)" oninput="updateCharCount('text2-count', this.value, 1000)"></textarea>
                        <div class="char-count"><span id="text2-count">0</span>/1000</div>
                    </div>
                </div>

                <div class="submit-section">
                    <button class="submit-btn" onclick="submitSurvey()">ì„¤ë¬¸ì¡°ì‚¬ ì œì¶œ</button>
                </div>
            `;

            // ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ë§
            addRadioListeners();
        }

        function addRadioListeners() {
            document.querySelectorAll('.radio-item input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // ê°™ì€ name ê·¸ë£¹ì˜ ëª¨ë“  ë¼ë””ì˜¤ ì•„ì´í…œì—ì„œ checked í´ë˜ìŠ¤ ì œê±°
                    document.querySelectorAll(`input[name="${this.name}"]`).forEach(r => {
                        r.closest('.radio-item').classList.remove('checked');
                    });
                    // ì„ íƒëœ ì•„ì´í…œì— checked í´ë˜ìŠ¤ ì¶”ê°€
                    this.closest('.radio-item').classList.add('checked');
                });
            });
        }

        function updateAnswer(key, value) {
            answers[key] = value;
        }

        function selectScale(questionId, value) {
            updateAnswer(questionId, value);
            // ì‹œê°ì  ì—…ë°ì´íŠ¸
            const scaleGroup = document.getElementById(`${questionId.replace('_', '-')}-scale`);
            if (scaleGroup) {
                scaleGroup.querySelectorAll('.scale-item').forEach((item, index) => {
                    item.classList.toggle('selected', index + 1 === value);
                });
            }
        }

        function toggleQ3Other(show) {
            const otherDiv = document.getElementById('q3-other');
            if (otherDiv) {
                otherDiv.style.display = show ? 'block' : 'none';
                if (!show) {
                    delete answers.q3_text;
                }
            }
        }

        function toggleQ4Branch(type) {
            const q5Section = document.getElementById('q5-section');
            const q6Section = document.getElementById('q6-section');
            
            if (type === 'satisfied') {
                q5Section.classList.add('show');
                q6Section.classList.remove('show');
                delete answers.q6;
                // q6 ë¼ë””ì˜¤ ë²„íŠ¼ ì´ˆê¸°í™”
                document.querySelectorAll('input[name="q6"]').forEach(r => {
                    r.checked = false;
                    r.closest('.radio-item').classList.remove('checked');
                });
            } else if (type === 'dissatisfied') {
                q5Section.classList.remove('show');
                q6Section.classList.add('show');
                delete answers.q5;
                // q5 ë¼ë””ì˜¤ ë²„íŠ¼ ì´ˆê¸°í™”
                document.querySelectorAll('input[name="q5"]').forEach(r => {
                    r.checked = false;
                    r.closest('.radio-item').classList.remove('checked');
                });
            }
        }

        function updateCharCount(counterId, text, maxLength) {
            const counter = document.getElementById(counterId);
            if (counter) {
                counter.textContent = text.length;
                counter.style.color = text.length > maxLength ? '#e53e3e' : '#666';
            }
        }

        function validateAnswers() {
            const required = ['q1', 'q2', 'q3', 'q4', 'text2'];
            
            // Q4 ë¶„ê¸°ì— ë”°ë¥¸ ì¶”ê°€ í•„ìˆ˜ í•­ëª©
            if (answers.q4 === 'ë§¤ìš° ë§Œì¡±' || answers.q4 === 'ë§Œì¡±') {
                required.push('q5');
            } else if (answers.q4 === 'ë¶ˆë§Œì¡±' || answers.q4 === 'ë§¤ìš° ë¶ˆë§Œì¡±') {
                required.push('q6');
            }

            // Q3 ê¸°íƒ€ ì„ íƒ ì‹œ í…ìŠ¤íŠ¸ í•„ìˆ˜
            if (answers.q3 === 'ê¸°íƒ€') {
                required.push('q3_text');
            }

            // ê³¼ëª©ë³„ í‰ê°€ í•„ìˆ˜
            if (surveyData && surveyData.subjects) {
                surveyData.subjects.forEach((_, index) => {
                    required.push(`subject_${index}`);
                });
            }

            const missing = required.filter(key => !answers[key] || answers[key].toString().trim() === '');
            
            if (missing.length > 0) {
                alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return false;
            }

            return true;
        }

        async function submitSurvey() {
            if (!validateAnswers()) {
                return;
            }

            const submitBtn = document.querySelector('.submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì œì¶œ ì¤‘...';

            try {
                // ê³¼ëª©ë³„ ì ìˆ˜ ì •ë¦¬
                const subjects = [];
                if (surveyData && surveyData.subjects) {
                    surveyData.subjects.forEach((subject, index) => {
                        if (answers[`subject_${index}`]) {
                            subjects.push({
                                name: subject.name,
                                instructor: subject.instructor,
                                score: parseInt(answers[`subject_${index}`])
                            });
                        }
                    });
                }

                const payload = {
                    action: 'submitSurvey',
                    token: token,
                    answers: {
                        ...answers,
                        subjects: subjects
                    }
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    showCompleted();
                } else {
                    throw new Error(result.message || 'ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì œì¶œ ì˜¤ë¥˜:', error);
                alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        function showCompleted() {
            app.innerHTML = `
                <div class="complete-section">
                    <div class="complete-icon">âœ…</div>
                    <div class="complete-title">ì„¤ë¬¸ì¡°ì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</div>
                    <div class="complete-message">
                        ì†Œì¤‘í•œ ì˜ê²¬ì„ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.<br>
                        ë” ë‚˜ì€ êµìœ¡ ì„œë¹„ìŠ¤ ì œê³µì„ ìœ„í•´ í™œìš©í•˜ê² ìŠµë‹ˆë‹¤.
                    </div>
                    <button class="back-btn" onclick="goBack()">QRì½”ë“œ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            `;
        }

        function showAlreadySubmitted() {
            app.innerHTML = `
                <div class="error-section">
                    <div class="error-icon">ğŸ“</div>
                    <div class="error-title">ì´ë¯¸ ì„¤ë¬¸ì„ ì œì¶œí•˜ì…¨ìŠµë‹ˆë‹¤</div>
                    <div class="error-message">
                        ì´ë¯¸ ì„¤ë¬¸ì¡°ì‚¬ë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.<br>
                        ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.
                    </div>
                    <button class="back-btn" onclick="goBack()">QRì½”ë“œ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</button>
                </div>
            `;
        }

        function showError(title, message) {
            app.innerHTML = `
                <div class="error-section">
                    <div class="error-icon">âš ï¸</div>
                    <div class="error-title">${escapeHtml(title)}</div>
                    <div class="error-message">${escapeHtml(message)}</div>
                    <button class="back-btn" onclick="goBack()">ëŒì•„ê°€ê¸°</button>
                </div>
            `;
        }

        function goBack() {
            if (history.length > 1) {
                history.back();
            } else {
                window.location.href = `qr.html?token=${encodeURIComponent(token)}`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
