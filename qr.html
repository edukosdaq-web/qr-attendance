<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ì½”ìŠ¤ë‹¥í˜‘íšŒ ì¶œì„ QR</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f0f2f5;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.card{background:#fff;border-radius:20px;padding:40px 30px;max-width:380px;width:100%;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.08)}
.org{color:#888;font-size:13px;margin-bottom:4px}
.title{font-size:20px;font-weight:700;margin-bottom:24px}
.qr-wrap{background:#fff;border:3px solid #e8e8e8;border-radius:16px;padding:20px;display:inline-block;margin-bottom:12px}
.token{color:#999;font-size:11px;word-break:break-all;margin-bottom:20px}
.info{background:#f8f9fa;border-radius:12px;padding:14px;text-align:left;font-size:13px;color:#555;line-height:1.7}
.info strong{color:#333}
.tip{margin-top:16px;background:#fffbe6;border:1px solid #ffe58f;border-radius:10px;padding:10px 14px;font-size:12px;color:#ad8b00}
.error{color:#e74c3c;font-size:15px;line-height:1.8;padding:20px 0}
.survey-block{padding:20px 0}
.survey-icon{font-size:48px;margin-bottom:12px}
.survey-msg{font-size:16px;font-weight:600;color:#d97706;margin-bottom:8px}
.survey-sub{font-size:13px;color:#666;margin-bottom:20px;line-height:1.6}
.survey-btn{display:inline-block;background:#2563eb;color:#fff;font-size:16px;font-weight:600;padding:14px 32px;border-radius:12px;text-decoration:none;margin-bottom:12px;cursor:pointer}
.survey-btn:hover{background:#1d4ed8}
.survey-done-btn{display:inline-block;background:#22c55e;color:#fff;font-size:16px;font-weight:600;padding:14px 32px;border-radius:12px;text-decoration:none;cursor:pointer}
.overlay{position:absolute;inset:0;background:rgba(255,255,255,.95);display:flex;align-items:center;justify-content:center;border-radius:20px;z-index:10}
</style>
</head>
<body>
<div class="card" id="card" style="position:relative">
  <div class="org">ì½”ìŠ¤ë‹¥í˜‘íšŒ</div>
  <div class="title">ì¶œì„ QRì½”ë“œ</div>
  <div id="content">
    <div id="qr-area" style="display:none">
      <div class="qr-wrap"><canvas id="qr"></canvas></div>
      <div class="token" id="token-text"></div>
      <div class="info">ğŸ“‹ <strong>ì•ˆë‚´</strong><br>â€¢ í˜„ì¥ ì…êµ¬ì—ì„œ ì´ í™”ë©´ì„ ë³´ì—¬ì£¼ì„¸ìš”.<br>â€¢ í™”ë©´ ë°ê¸°ë¥¼ ìµœëŒ€ë¡œ ì˜¬ë ¤ì£¼ì„¸ìš”.<br>â€¢ ì´ í˜ì´ì§€ë¥¼ ì¦ê²¨ì°¾ê¸° í•´ë‘ì‹œë©´ í¸ë¦¬í•©ë‹ˆë‹¤.</div>
      <div class="tip">ğŸ’¡ ìŠ¤ìº”ì´ ì•ˆ ë˜ë©´ í™”ë©´ ë°ê¸°ë¥¼ ìµœëŒ€ë¡œ ì˜¬ë ¤ì£¼ì„¸ìš”</div>
    </div>
    <div id="loading-area" style="padding:20px 0;color:#999">ì¶œì„ ì •ë³´ í™•ì¸ ì¤‘...</div>
    <div id="survey-area" style="display:none"></div>
    <div id="error-area" style="display:none"></div>
  </div>
  <div id="overlay" class="overlay" style="display:none"><div style="color:#999">í™•ì¸ ì¤‘...</div></div>
</div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbz5sEyjgPzbzSGEQl9q3tI2_wJv5zX5YuAYkXpLM8ThsF3yJS6FaksEVl0CCl7R3dFP/exec';
const params=new URLSearchParams(location.search);
const token=params.get('token');

const CACHE_KEY='kosdaq_qr_'+token;
const CACHE_TTL=300000; // 5ë¶„

if(!token){
  showError('QR í† í°ì´ ì—†ìŠµë‹ˆë‹¤.','ë¬¸ìì—ì„œ ë§í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.');
}else{
  prepareQR();
  // ìºì‹œ í™•ì¸ â†’ ì¦‰ì‹œ í‘œì‹œ
  const cached=getCache();
  if(cached){
    if(cached.allowed) showQR();
    else{ document.getElementById('loading-area').style.display='none'; showSurveyRequired(cached); }
    // ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹ 
    checkAccess(true);
  }else{
    checkAccess(false);
  }
}

function getCache(){
  try{
    const raw=localStorage.getItem(CACHE_KEY);
    if(!raw)return null;
    const obj=JSON.parse(raw);
    if(Date.now()-obj._ts>CACHE_TTL)return null;
    return obj;
  }catch(e){return null}
}
function setCache(data){
  try{localStorage.setItem(CACHE_KEY,JSON.stringify({...data,_ts:Date.now()}))}catch(e){}
}

function prepareQR(){
  document.getElementById('token-text').textContent=token;
  QRCode.toCanvas(document.getElementById('qr'),token,{width:220,margin:2}).catch(()=>{});
}

function showQR(){
  document.getElementById('loading-area').style.display='none';
  document.getElementById('survey-area').style.display='none';
  document.getElementById('qr-area').style.display='block';
}

async function checkAccess(silent){
  try{
    const res=await fetch(API_URL+'?action=checkQRAccess&token='+encodeURIComponent(token),{redirect:'follow'});
    const json=await res.json();
    if(json.status==='ok'&&json.data){
      const d=json.data;
      setCache(d);
      if(!silent){
        if(!d.allowed){
          document.getElementById('loading-area').style.display='none';
          showSurveyRequired(d);
        }else{
          showQR();
        }
      }else{
        // ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹ : ìƒíƒœ ë³€ê²½ ì‹œ ë°˜ì˜
        if(d.allowed){
          showQR();
        }else if(document.getElementById('qr-area').style.display==='block'){
          document.getElementById('qr-area').style.display='none';
          document.getElementById('loading-area').style.display='none';
          showSurveyRequired(d);
        }
      }
    }else if(!silent){
      showQR();
    }
  }catch(e){
    if(!silent) showQR();
  }
}

function showSurveyRequired(data){
  // ì„¤ë¬¸ URL ê²°ì •: ìì²´ ì„¤ë¬¸ vs ì™¸ë¶€ URL
  let surveyLink='';
  if(data.hasSurvey){
    surveyLink='survey.html?token='+encodeURIComponent(token);
  }else if(data.surveyUrl){
    surveyLink=data.surveyUrl;
  }

  const area=document.getElementById('survey-area');
  area.style.display='block';
  area.innerHTML=
    '<div class="survey-block">'+
      '<div class="survey-icon">ğŸ“</div>'+
      '<div class="survey-msg">ì„¤ë¬¸ì¡°ì‚¬ë¥¼ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”</div>'+
      '<div class="survey-sub">ë§ˆì§€ë§‰ ë‚  ì¶œì„ QRì½”ë“œëŠ”<br>ì„¤ë¬¸ì¡°ì‚¬ ì™„ë£Œ í›„ í‘œì‹œë©ë‹ˆë‹¤.<br><br><span style="font-size:12px;color:#999">â€» ì„¤ë¬¸ ì‹œ ì…ë ¥í•˜ì‹  ì´ë¦„ì€ ì¶œì„ í™•ì¸ í›„<br>ì•”í˜¸í™” ì²˜ë¦¬ë˜ì–´ ì„¤ë¬¸ ì‘ë‹µìëŠ” í™•ì¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span></div>'+
      (surveyLink?'<a class="survey-btn" href="'+escHtml(surveyLink)+'" target="_blank">ğŸ“ ì„¤ë¬¸ì¡°ì‚¬ ë°”ë¡œê°€ê¸°</a><br><br>':'')+
      '<span class="survey-done-btn" id="surveyDoneBtn">âœ… ì„¤ë¬¸ ì™„ë£Œí–ˆì–´ìš”</span>'+
    '</div>';

  // ì„¤ë¬¸ íƒ­ì—ì„œ ëŒì•„ì˜¤ë©´ ìë™ ì¬í™•ì¸
  window.addEventListener('focus',function onFocus(){
    window.removeEventListener('focus',onFocus);
    const btn=document.getElementById('surveyDoneBtn');
    if(btn) btn.click();
  });

  document.getElementById('surveyDoneBtn').onclick=async function(){
    this.textContent='í™•ì¸ ì¤‘...';this.style.opacity='0.6';this.style.pointerEvents='none';
    try{
      const res=await fetch(API_URL+'?action=checkQRAccess&token='+encodeURIComponent(token),{redirect:'follow'});
      const json=await res.json();
      if(json.status==='ok'&&json.data&&json.data.allowed){
        area.style.display='none';
        showQRInstant();
      }else{
        this.textContent='âŒ ì„¤ë¬¸ì´ ì•„ì§ í™•ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';this.style.background='#ef4444';this.style.opacity='1';
        setTimeout(()=>{this.textContent='âœ… ì„¤ë¬¸ ì™„ë£Œí–ˆì–´ìš”';this.style.background='#22c55e';this.style.opacity='1';this.style.pointerEvents='auto'},3000);
      }
    }catch(e){
      area.style.display='none';
      showQRInstant();
    }
  };
}

function showError(title,msg){
  document.getElementById('loading-area').style.display='none';
  const area=document.getElementById('error-area');
  area.style.display='block';
  area.innerHTML='<div class="error"><strong>'+escHtml(title)+'</strong><br>'+escHtml(msg)+'</div>';
}

function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
</script>
</body>
</html>
