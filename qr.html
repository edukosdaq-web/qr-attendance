<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ì½”ìŠ¤ë‹¥í˜‘íšŒ ì¶œì„ QR</title>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f0f2f5;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.card{background:#fff;border-radius:20px;padding:40px 30px;max-width:380px;width:100%;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,.08)}
.org{color:#888;font-size:13px;margin-bottom:4px}
.title{font-size:20px;font-weight:700;margin-bottom:24px}
.qr-wrap{background:#fff;border:3px solid #e8e8e8;border-radius:16px;padding:20px;display:inline-block;margin-bottom:12px}
.token{color:#999;font-size:11px;word-break:break-all;margin-bottom:20px}
.info{background:#f8f9fa;border-radius:12px;padding:14px;text-align:left;font-size:13px;color:#555;line-height:1.7}
.info strong{color:#333}
.tip{margin-top:16px;background:#fffbe6;border:1px solid #ffe58f;border-radius:10px;padding:10px 14px;font-size:12px;color:#ad8b00}
.error{color:#e74c3c;font-size:15px;line-height:1.8;padding:20px 0}
/* ì„¤ë¬¸ ì•ˆë‚´ */
.survey-block{padding:20px 0}
.survey-icon{font-size:48px;margin-bottom:12px}
.survey-msg{font-size:16px;font-weight:600;color:#d97706;margin-bottom:8px}
.survey-sub{font-size:13px;color:#666;margin-bottom:20px;line-height:1.6}
.survey-btn{display:inline-block;background:#2563eb;color:#fff;font-size:16px;font-weight:600;padding:14px 32px;border-radius:12px;text-decoration:none;margin-bottom:12px}
.survey-btn:hover{background:#1d4ed8}
.refresh-btn{display:inline-block;background:#f3f4f6;color:#374151;font-size:13px;font-weight:500;padding:10px 24px;border-radius:8px;text-decoration:none;cursor:pointer;border:1px solid #d1d5db}
.refresh-btn:hover{background:#e5e7eb}
.name-tag{font-size:18px;font-weight:700;color:#1f2937;margin-bottom:4px}
.company-tag{font-size:13px;color:#6b7280;margin-bottom:16px}
</style>
</head>
<body>
<div class="card" id="card">
  <div class="org">ì½”ìŠ¤ë‹¥í˜‘íšŒ</div>
  <div class="title">ì¶œì„ QRì½”ë“œ</div>
  <div id="content">
    <div style="padding:20px 0;color:#999">í™•ì¸ ì¤‘...</div>
  </div>
</div>

<script>
const API_URL='https://script.google.com/macros/s/AKfycbz5sEyjgPzbzSGEQl9q3tI2_wJv5zX5YuAYkXpLM8ThsF3yJS6FaksEVl0CCl7R3dFP/exec';
const params=new URLSearchParams(location.search);
const token=params.get('token');
const content=document.getElementById('content');

if(!token){
  content.innerHTML='<div class="error">QR í† í°ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë¬¸ìì—ì„œ ë§í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
}else{
  // API í˜¸ì¶œí•˜ì—¬ ì ‘ê·¼ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
  checkAccess();
}

async function checkAccess(){
  try{
    const res=await fetch(API_URL+'?action=checkQRAccess&token='+encodeURIComponent(token),{redirect:'follow'});
    const json=await res.json();
    
    if(json.status==='ok'&&json.data){
      const d=json.data;
      if(d.allowed){
        showQR(d);
      }else{
        showSurveyRequired(d);
      }
    }else{
      // API ì—ëŸ¬ â†’ í´ë°±: QR í‘œì‹œ
      showQRFallback();
    }
  }catch(e){
    // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ â†’ í´ë°±: QR í‘œì‹œ
    showQRFallback();
  }
}

function showQR(data){
  let nameHtml='';
  if(data.ì´ë¦„){
    nameHtml='<div class="name-tag">'+escHtml(data.ì´ë¦„)+'</div>';
    if(data.íšŒì‚¬) nameHtml+='<div class="company-tag">'+escHtml(data.íšŒì‚¬)+'</div>';
  }
  // ë§ˆì§€ë§‰ ë‚  + ì„¤ë¬¸ ë¯¸ì™„ë£Œ ì‹œ ì•ˆë‚´ ë°°ë„ˆ
  let surveyBanner='';
  if(data.isLastDay&&!data.surveyCompleted&&data.surveyUrl){
    surveyBanner='<div style="background:#fef3c7;border:2px solid #f59e0b;border-radius:12px;padding:12px 16px;margin-bottom:16px;text-align:center">'+
      '<div style="font-size:14px;font-weight:600;color:#d97706;margin-bottom:6px">ğŸ“ ì„¤ë¬¸ì¡°ì‚¬ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”</div>'+
      '<a href="'+escHtml(data.surveyUrl)+'" target="_blank" style="display:inline-block;background:#2563eb;color:#fff;font-size:14px;font-weight:600;padding:8px 20px;border-radius:8px;text-decoration:none">ì„¤ë¬¸ì¡°ì‚¬ ë°”ë¡œê°€ê¸°</a>'+
      '</div>';
  }
  content.innerHTML=nameHtml+surveyBanner+
    '<div class="qr-wrap"><canvas id="qr"></canvas></div>'+
    '<div class="token">'+escHtml(token)+'</div>'+
    '<div class="info">ğŸ“‹ <strong>ì•ˆë‚´</strong><br>â€¢ í˜„ì¥ ì…êµ¬ì—ì„œ ì´ í™”ë©´ì„ ë³´ì—¬ì£¼ì„¸ìš”.<br>â€¢ í™”ë©´ ë°ê¸°ë¥¼ ìµœëŒ€ë¡œ ì˜¬ë ¤ì£¼ì„¸ìš”.<br>â€¢ ì´ í˜ì´ì§€ë¥¼ ì¦ê²¨ì°¾ê¸° í•´ë‘ì‹œë©´ í¸ë¦¬í•©ë‹ˆë‹¤.</div>'+
    '<div class="tip">ğŸ’¡ ìŠ¤ìº”ì´ ì•ˆ ë˜ë©´ í™”ë©´ ë°ê¸°ë¥¼ ìµœëŒ€ë¡œ ì˜¬ë ¤ì£¼ì„¸ìš”</div>';
  QRCode.toCanvas(document.getElementById('qr'),token,{width:220,margin:2}).catch(()=>{});
}

function showQRFallback(){
  content.innerHTML=
    '<div class="qr-wrap"><canvas id="qr"></canvas></div>'+
    '<div class="token">'+escHtml(token)+'</div>'+
    '<div class="info">ğŸ“‹ <strong>ì•ˆë‚´</strong><br>â€¢ í˜„ì¥ ì…êµ¬ì—ì„œ ì´ í™”ë©´ì„ ë³´ì—¬ì£¼ì„¸ìš”.<br>â€¢ í™”ë©´ ë°ê¸°ë¥¼ ìµœëŒ€ë¡œ ì˜¬ë ¤ì£¼ì„¸ìš”.<br>â€¢ ì´ í˜ì´ì§€ë¥¼ ì¦ê²¨ì°¾ê¸° í•´ë‘ì‹œë©´ í¸ë¦¬í•©ë‹ˆë‹¤.</div>'+
    '<div class="tip">ğŸ’¡ ìŠ¤ìº”ì´ ì•ˆ ë˜ë©´ í™”ë©´ ë°ê¸°ë¥¼ ìµœëŒ€ë¡œ ì˜¬ë ¤ì£¼ì„¸ìš”</div>';
  QRCode.toCanvas(document.getElementById('qr'),token,{width:220,margin:2}).catch(()=>{});
}

function showSurveyRequired(data){
  let nameHtml='';
  if(data.ì´ë¦„){
    nameHtml='<div class="name-tag">'+escHtml(data.ì´ë¦„)+'</div>';
    if(data.íšŒì‚¬) nameHtml+='<div class="company-tag">'+escHtml(data.íšŒì‚¬)+'</div>';
  }
  content.innerHTML=nameHtml+
    '<div class="survey-block">'+
      '<div class="survey-icon">ğŸ“</div>'+
      '<div class="survey-msg">ì„¤ë¬¸ì¡°ì‚¬ë¥¼ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”</div>'+
      '<div class="survey-sub">ë§ˆì§€ë§‰ ë‚  ì¶œì„ QRì½”ë“œëŠ”<br>ì„¤ë¬¸ì¡°ì‚¬ ì™„ë£Œ í›„ í‘œì‹œë©ë‹ˆë‹¤.<br><br><span style="font-size:12px;color:#999">â€» ì„¤ë¬¸ ì‹œ ì…ë ¥í•˜ì‹  ì´ë¦„ì€ ì¶œì„ í™•ì¸ í›„<br>ì•”í˜¸í™” ì²˜ë¦¬ë˜ì–´ ì„¤ë¬¸ ì‘ë‹µìëŠ” í™•ì¸ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</span></div>'+
      (data.surveyUrl?'<a class="survey-btn" href="'+escHtml(data.surveyUrl)+'" target="_blank">ğŸ“ ì„¤ë¬¸ì¡°ì‚¬ ë°”ë¡œê°€ê¸°</a><br><br>':'')+
      '<span class="survey-btn" style="background:#22c55e;cursor:pointer" id="surveyDoneBtn">âœ… ì„¤ë¬¸ ì™„ë£Œí–ˆì–´ìš”</span>'+
    '</div>';
  document.getElementById('surveyDoneBtn').onclick=async function(){
    this.textContent='í™•ì¸ ì¤‘...';this.style.opacity='0.6';this.style.pointerEvents='none';
    // markSurvey í˜¸ì¶œí•˜ì§€ ì•ŠìŒ â€” ê´€ë¦¬ìê°€ ì„¤ë¬¸ ì™„ë£Œ ì²˜ë¦¬í•´ì•¼ QR í‘œì‹œ
    // checkQRAccessë§Œ ì¬í™•ì¸
    try{
      const res=await fetch(API_URL+'?action=checkQRAccess&token='+encodeURIComponent(token),{redirect:'follow'});
      const json=await res.json();
      if(json.status==='ok'&&json.data&&json.data.allowed){
        showQR(json.data);
      }else{
        this.textContent='âŒ ì„¤ë¬¸ì´ ì•„ì§ í™•ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤';this.style.background='#ef4444';this.style.opacity='1';
        setTimeout(()=>{this.textContent='âœ… ì„¤ë¬¸ ì™„ë£Œí–ˆì–´ìš”';this.style.background='#22c55e';this.style.opacity='1';this.style.pointerEvents='auto'},3000);
      }
    }catch(e){
      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ í´ë°±ìœ¼ë¡œ QR í‘œì‹œ
      showQRFallback();
    }
  };
}

function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
</script>
</body>
</html>
