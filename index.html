<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì½”ìŠ¤ë‹¥í˜‘íšŒ QR ì¶œì„ ì‹œìŠ¤í…œ v4</title>
<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2/dist/jspdf.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}
.scanner-input{border:2px solid #3b82f6!important;background:#eff6ff;font-size:18px!important;font-family:monospace}
.scanner-input:focus{border-color:#7c3aed!important;box-shadow:0 0 0 4px rgba(124,58,237,.15)!important}
.scan-flash{position:fixed;inset:0;z-index:400;pointer-events:none;animation:flashAnim .5s ease-out forwards}
@keyframes flashAnim{0%{opacity:.4}100%{opacity:0}}
.scan-result-big{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:300;padding:40px 56px;border-radius:24px;text-align:center;min-width:380px;animation:popIn .2s ease-out}
@keyframes popIn{from{transform:translate(-50%,-50%) scale(.8);opacity:0}to{transform:translate(-50%,-50%) scale(1);opacity:1}}
.scan-result-big.success{background:#dcfce7;border:4px solid #22c55e;color:#166534}
.scan-result-big.error{background:#fee2e2;border:4px solid #ef4444;color:#991b1b}
.scan-result-big.duplicate{background:#fef9c3;border:4px solid #eab308;color:#854d0e}
@media print{.no-print{display:none!important}}
@media(max-width:768px){.sidebar-wrap{display:none!important}.mobile-nav{display:flex!important}}
.mobile-nav{display:none}
.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(0,0,0,.1);border-radius:50%;border-top-color:#3b82f6;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.7);display:flex;align-items:center;justify-content:center;z-index:500}
</style>
</head>
<body class="bg-gray-50 text-gray-900">
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo}=React;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API Configuration
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const API_URL='https://script.google.com/macros/s/AKfycbz5sEyjgPzbzSGEQl9q3tI2_wJv5zX5YuAYkXpLM8ThsF3yJS6FaksEVl0CCl7R3dFP/exec';
const DEV_MODE=false; // trueì´ë©´ ì‹œë®¬ë ˆì´ì…˜ ë²„íŠ¼ í‘œì‹œ

/* â”€â”€â”€ API Helper â”€â”€â”€ */
async function apiGet(action,params={}){
  const qs=new URLSearchParams({action,...params}).toString();
  const url=`${API_URL}?${qs}`;
  try{
    const res=await fetch(url,{redirect:'follow'});
    const json=await res.json();
    return json;
  }catch(e){
    console.error('API GET error:',action,e);
    throw e;
  }
}

async function apiPost(body){
  try{
    const res=await fetch(API_URL,{
      method:'POST',
      redirect:'follow',
      headers:{'Content-Type':'text/plain'},
      body:JSON.stringify(body),
    });
    const json=await res.json();
    return json;
  }catch(e){
    console.error('API POST error:',body.action,e);
    throw e;
  }
}

/* â”€â”€â”€ LocalStorage Cache â”€â”€â”€ */
const CACHE_KEY='kosdaq_qr_v4_cache';
function cacheGet(key){try{const c=JSON.parse(localStorage.getItem(CACHE_KEY)||'{}');return c[key]}catch(e){return null}}
function cacheSet(key,val){try{const c=JSON.parse(localStorage.getItem(CACHE_KEY)||'{}');c[key]=val;c[key+'_ts']=Date.now();localStorage.setItem(CACHE_KEY,JSON.stringify(c))}catch(e){}}

/* â”€â”€â”€ Audio â”€â”€â”€ */
const AudioCtx=window.AudioContext||window.webkitAudioContext;
let audioCtx=null;
function playBeep(type){
  try{
    if(!audioCtx)audioCtx=new AudioCtx();
    const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
    osc.connect(gain);gain.connect(audioCtx.destination);gain.gain.value=0.3;
    if(type==='success'){osc.frequency.value=880;osc.type='sine'}
    else if(type==='error'){osc.frequency.value=220;osc.type='square'}
    else{osc.frequency.value=440;osc.type='triangle'}
    osc.start();osc.stop(audioCtx.currentTime+(type==='error'?0.3:0.15));
  }catch(e){}
}

/* â”€â”€â”€ UUID â”€â”€â”€ */
function uuid(){return'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0;return(c==='x'?r:(r&0x3|0x8)).toString(16)})}

/* â”€â”€â”€ Focus Lock â”€â”€â”€ */
function useFocusLock(ref,active=true){
  useEffect(()=>{
    if(!active)return;
    const el=ref.current;if(!el)return;
    el.focus();
    const t=setInterval(()=>{if(document.activeElement!==el)el.focus()},500);
    return()=>clearInterval(t);
  },[active]);
}

/* â”€â”€â”€ Loading Component â”€â”€â”€ */
function Spinner({size='sm'}){
  const s=size==='lg'?'w-8 h-8 border-4':'w-5 h-5 border-3';
  return <span className={`loading-spinner ${s}`}/>;
}
function LoadingOverlay({text}){
  return <div className="loading-overlay"><div className="text-center"><Spinner size="lg"/><div className="mt-3 text-gray-600 font-semibold">{text||'ë¡œë”© ì¤‘...'}</div></div></div>;
}

/* â”€â”€â”€ Field Mapping: API í•œê¸€ â†’ í”„ë¡ íŠ¸ ì˜ë¬¸ â”€â”€â”€ */
function parseDate(v){if(!v)return'';const d=new Date(v);if(isNaN(d))return v;return d.toLocaleDateString('ko-KR',{year:'numeric',month:'2-digit',day:'2-digit'}).replace(/\.\s?/g,'-').replace(/-$/,'')}
function mapTraining(t){
  const today=new Date();today.setHours(0,0,0,0);
  const rawStart=t.ì‹œì‘ì¼||t.startDate||'';
  const rawEnd=t.ì¢…ë£Œì¼||t.endDate||'';
  const sd=rawStart?new Date(rawStart):null;
  const ed=rawEnd?new Date(rawEnd):null;
  let status=t.ìƒíƒœ||t.status||'preparing';
  // ìƒíƒœ ìë™ íŒì •: ì¤€ë¹„ì¤‘/active/upcoming ë“± ì„œë²„ê°’ ë¬´ì‹œí•˜ê³  ë‚ ì§œ ê¸°ì¤€
  if(sd&&ed){if(today>ed)status='completed';else if(today>=sd)status='active';else status='preparing';}
  else if(status==='ì¤€ë¹„ì¤‘')status='preparing';
  return{
    id:t.ì—°ìˆ˜id||t.id,
    name:t.ì—°ìˆ˜ëª…||t.name||'',
    startDate:parseDate(rawStart),
    endDate:parseDate(rawEnd),
    days:Number(t.ì¼ìˆ˜||t.days||1),
    status,
    surveyUrl:t.ì„¤ë¬¸URL||'',
  };
}
function mapParticipant(p,tid){
  return{
    id:p.ì°¸ê°€ìid||p.id||uuid(),
    trainingId:tid||p.ì—°ìˆ˜id||p.trainingId,
    name:p.ì´ë¦„||p.name||'',
    company:p.íšŒì‚¬||p.ì†Œì†ì‚¬||p.company||'',
    position:p.ì§ê¸‰||p.position||'',
    phone:p.ì—°ë½ì²˜||p.phone||'',
    email:p.ì´ë©”ì¼||p.email||'',
    manager:p.ë‹´ë‹¹ì||p.manager||'',
    qrCode:p.QRì½”ë“œ||p.qrCode||'',
    surveyCompleted:p.ì„¤ë¬¸ì™„ë£Œ==='Y'||p.ì„¤ë¬¸ì™„ë£Œ===true||p.surveyCompleted||false,
    certificateIssued:p.ìˆ˜ë£Œì—¬ë¶€==='Y'||p.ìˆ˜ë£Œì—¬ë¶€===true||p.certificateIssued||false,
  };
}
function mapCard(c){
  return{
    id:c.ì¹´ë“œid||c.id||uuid(),
    qrCode:c.QRì½”ë“œ||c.ì¹´ë“œQR||c.qrCode||'',
    status:c.ìƒíƒœ||c.status||'available',
    participantId:c.ì°¸ê°€ìid||c.participantId||null,
    participantName:c.ì°¸ê°€ìì´ë¦„||c.participantName||'',
    mappedAt:c.ë§¤í•‘ì¼ì‹œ||c.mappedAt||null,
    returnedAt:c.ë°˜ë‚©ì¼ì‹œ||c.returnedAt||null,
  };
}
function mapAttendance(a){
  return{
    id:a.ì¶œì„id||a.id||uuid(),
    participantId:a.ì°¸ê°€ìid||a.participantId,
    trainingId:a.ì—°ìˆ˜id||a.trainingId,
    day:Number(a.ì¼ì°¨||a.day),
    session:a.ì„¸ì…˜||a.ì‹œê°„ëŒ€||a.session,
    checkedAt:a.ì²´í¬ì‹œê°||a.ì¶œì„ì‹œê°||a.checkedAt,
    method:a.ë°©ë²•||a.method||'scanner',
    late:a.ì§€ê°ì—¬ë¶€==='Y'||a.late||false,
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   App
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function App(){
  const [loggedIn,setLoggedIn]=useState(!!sessionStorage.getItem('kosdaq_v4_auth'));
  const [page,setPage]=useState('dashboard');
  const [selTraining,setSelTraining]=useState(null);
  const [toast,setToast]=useState(null);
  const [scanResult,setScanResult]=useState(null);
  const [flash,setFlash]=useState(null);
  const [globalLoading,setGlobalLoading]=useState(false);

  // Data state
  const [trainings,setTrainings]=useState([]);
  const [participants,setParticipants]=useState([]);
  const [cards,setCards]=useState([]);
  const [attendance,setAttendance]=useState([]);

  const showToast=useCallback((msg,type='ok')=>{setToast({msg,type});setTimeout(()=>setToast(null),2000)},[]);
  const showScanResult=useCallback((type,icon,name,detail)=>{
    setScanResult({type,icon,name,detail});playBeep(type);
    setFlash(type);setTimeout(()=>setFlash(null),500);
    setTimeout(()=>setScanResult(null),2500);
  },[]);

  /* â”€â”€â”€ Data Loading â”€â”€â”€ */
  const loadTrainings=useCallback(async()=>{
    try{
      const res=await apiGet('getTrainings');
      const list=(res.data||res||[]).map(mapTraining);
      setTrainings(list);
      cacheSet('trainings',list);
      return list;
    }catch(e){
      const cached=cacheGet('trainings');
      if(cached){setTrainings(cached);showToast('âš ï¸ ì˜¤í”„ë¼ì¸ ëª¨ë“œ (ìºì‹œ)','warn')}
      else showToast('âŒ ì—°ìˆ˜ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨','err');
      return cached||[];
    }
  },[showToast]);

  const loadParticipants=useCallback(async(tid)=>{
    try{
      const res=await apiGet('getParticipants',{tid});
      const list=(res.data||res||[]).map(p=>mapParticipant(p,tid));
      setParticipants(prev=>{
        const other=prev.filter(p=>p.trainingId!==tid);
        return[...other,...list];
      });
      cacheSet(`participants_${tid}`,list);
      return list;
    }catch(e){
      const cached=cacheGet(`participants_${tid}`);
      if(cached){setParticipants(prev=>[...prev.filter(p=>p.trainingId!==tid),...cached]);return cached}
      return[];
    }
  },[]);

  const loadCards=useCallback(async()=>{
    try{
      const res=await apiGet('getCards');
      const list=(res.data||res||[]).map(mapCard);
      setCards(list);
      cacheSet('cards',list);
      return list;
    }catch(e){
      const cached=cacheGet('cards');
      if(cached)setCards(cached);
      return cached||[];
    }
  },[]);

  const loadAttendance=useCallback(async(tid,day)=>{
    try{
      const params={tid};
      if(day)params.day=String(day);
      const res=await apiGet('getAttendance',params);
      const list=(res.data||res||[]).map(mapAttendance);
      if(day){
        setAttendance(prev=>{
          const other=prev.filter(a=>!(a.trainingId===tid&&a.day===Number(day)));
          return[...other,...list];
        });
      }else{
        setAttendance(prev=>{
          const other=prev.filter(a=>a.trainingId!==tid);
          return[...other,...list];
        });
      }
      cacheSet(`attendance_${tid}${day?'_'+day:''}`,list);
      return list;
    }catch(e){
      const cached=cacheGet(`attendance_${tid}${day?'_'+day:''}`);
      return cached||[];
    }
  },[]);

  const loadAllForTraining=useCallback(async(tid)=>{
    setGlobalLoading(true);
    try{
      await Promise.all([loadParticipants(tid),loadCards(),loadAttendance(tid)]);
    }finally{setGlobalLoading(false)}
  },[loadParticipants,loadCards,loadAttendance]);

  // Initial load
  useEffect(()=>{
    if(loggedIn)loadTrainings();
  },[loggedIn,loadTrainings]);

  const training=trainings.find(t=>t.id===selTraining);
  const curParticipants=useMemo(()=>participants.filter(p=>p.trainingId===selTraining),[participants,selTraining]);
  const curAttendance=useMemo(()=>attendance.filter(a=>a.trainingId===selTraining),[attendance,selTraining]);

  const selectTraining=async(id)=>{
    setSelTraining(id);
    setPage('training-dashboard');
    await loadAllForTraining(id);
  };
  const goBack=()=>{setSelTraining(null);setPage('dashboard')};

  if(!loggedIn)return <Login onLogin={()=>{sessionStorage.setItem('kosdaq_v4_auth','1');setLoggedIn(true)}}/>;

  const nav=selTraining?[
    {id:'training-dashboard',icon:'ğŸ“Š',label:'ëŒ€ì‹œë³´ë“œ'},
    {id:'upload',icon:'ğŸ“',label:'ëª…ë‹¨ ì—…ë¡œë“œ'},
    {id:'attendance',icon:'âœ…',label:'ì¶œì„ ì²´í¬'},
    {id:'completion',icon:'ğŸ“',label:'ìˆ˜ë£Œ ì²˜ë¦¬'},
    {id:'records',icon:'ğŸ“‹',label:'ì¶œì„ë¶€ ì¡°íšŒ'},
  ]:[];

  const getStats=(tid)=>{
    const ps=participants.filter(p=>p.trainingId===tid);
    const t=trainings.find(x=>x.id===tid);
    if(!ps.length||!t)return{total:0,mapped:0,mappingRate:0,attendanceRate:0,certRate:0,cardReturnRate:0,cert:0};
    const total=ps.length;
    const mapped=ps.filter(p=>cards.some(c=>c.participantId===p.id&&c.status!=='available')).length;
    const atts=attendance.filter(a=>a.trainingId===tid);
    const totalSessions=t.days*2;
    const attRate=totalSessions&&total?Math.round(atts.length/(total*totalSessions)*100):0;
    const cert=ps.filter(p=>p.certificateIssued).length;
    const returned=cards.filter(c=>ps.some(p=>p.id===c.participantId)&&c.returnedAt).length;
    return{total,mapped,mappingRate:total?Math.round(mapped/total*100):0,attendanceRate:attRate,certRate:total?Math.round(cert/total*100):0,cert,cardReturnRate:mapped?Math.round(returned/mapped*100):0};
  };

  const pg=()=>{
    if(!selTraining)return <Dashboard trainings={trainings} participants={participants} cards={cards} attendance={attendance} getStats={getStats} selectTraining={selectTraining} showToast={showToast} loadTrainings={loadTrainings}/>;
    if(!training)return <div className="p-8">ì—°ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>;
    const props={training,participants:curParticipants,cards,attendanceRecords:curAttendance,showToast,showScanResult,loadParticipants,loadCards,loadAttendance,loadAllForTraining,setParticipants,setCards,setAttendance};
    switch(page){
      case 'training-dashboard':return <TrainingDash {...props} getStats={getStats}/>;
      case 'upload':return <Upload {...props}/>;
      /* mapping í˜ì´ì§€ ì œê±° â€” ì¶œì„ ì²´í¬ì—ì„œ ìë™ ë§¤í•‘ */
      case 'attendance':return <AttendancePage {...props}/>;
      case 'completion':return <CompletionPage {...props}/>;
      case 'records':return <RecordsPage {...props}/>;
      default:return <TrainingDash {...props} getStats={getStats}/>;
    }
  };

  return(
    <div className="flex min-h-screen">
      {globalLoading&&<LoadingOverlay text="ë°ì´í„° ë¡œë”© ì¤‘..."/>}
      {flash&&<div className="scan-flash" style={{background:flash==='success'?'#22c55e':flash==='error'?'#ef4444':'#eab308'}}/>}
      <div className="sidebar-wrap w-64 bg-gray-900 text-white flex-shrink-0 flex flex-col" style={{minHeight:'100vh'}}>
        <div className="p-5 border-b border-gray-700">
          <div className="font-bold text-sm">ğŸ¢ KOSDAQ ì—°ìˆ˜</div>
          <div className="text-xs text-gray-500 mt-1">QR ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ v4.0</div>
        </div>
        {selTraining?(
          <>
            <div className="px-5 py-3 text-blue-400 cursor-pointer hover:bg-gray-800 text-sm flex items-center gap-2" onClick={goBack}>â† ì—°ìˆ˜ ëª©ë¡</div>
            <div className="px-5 py-1 text-xs text-gray-500 font-semibold">{training?.name}</div>
            {nav.map(n=>(
              <div key={n.id} className={`px-5 py-3 cursor-pointer text-sm flex items-center gap-2 ${page===n.id?'bg-gray-800 text-white border-l-2 border-blue-500':'text-gray-400 hover:text-white hover:bg-gray-800'}`} onClick={()=>setPage(n.id)}>
                {n.icon} {n.label}
              </div>
            ))}
          </>
        ):(
          <div className="px-5 py-3 bg-gray-800 text-white text-sm flex items-center gap-2">ğŸ“‹ ì—°ìˆ˜ ëª©ë¡</div>
        )}
        <div className="mt-auto p-4 border-t border-gray-700">
          <button className="w-full text-xs bg-gray-800 hover:bg-gray-700 text-gray-300 py-2 px-3 rounded" onClick={()=>{sessionStorage.removeItem('kosdaq_v4_auth');setLoggedIn(false)}}>ğŸ”’ ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
      <div className="mobile-nav bg-white border-b p-2 overflow-x-auto gap-2 fixed top-0 left-0 right-0 z-50">
        {selTraining&&<button className="px-3 py-1 text-xs border rounded whitespace-nowrap" onClick={goBack}>â† ëª©ë¡</button>}
        {nav.map(n=><button key={n.id} className={`px-3 py-1 text-xs rounded whitespace-nowrap ${page===n.id?'bg-blue-600 text-white':'border'}`} onClick={()=>setPage(n.id)}>{n.icon} {n.label}</button>)}
      </div>
      <main className="flex-1 p-6 overflow-x-auto md:p-6 pt-14 md:pt-6">{pg()}</main>
      {toast&&<div className={`fixed bottom-6 right-6 px-6 py-3 rounded-xl text-white font-semibold z-50 ${toast.type==='ok'?'bg-green-600':toast.type==='err'?'bg-red-600':'bg-yellow-600'}`} style={{animation:'popIn .3s'}}>{toast.msg}</div>}
      {scanResult&&<div className={`scan-result-big ${scanResult.type}`}>
        <div className="text-6xl mb-2">{scanResult.icon}</div>
        <div className="text-3xl font-extrabold">{scanResult.name}</div>
        <div className="text-lg mt-1 font-medium">{scanResult.detail}</div>
      </div>}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Login â€” uses getConfig API
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function Login({onLogin}){
  const [pw,setPw]=useState('');
  const [err,setErr]=useState(false);
  const [loading,setLoading]=useState(false);

  const handleLogin=async()=>{
    setLoading(true);
    try{
      const res=await apiGet('getConfig');
      const config=res.data||res||{};
      const sysPw=config.ì‹œìŠ¤í…œë¹„ë°€ë²ˆí˜¸||config.password||'kosdaq2026';
      if(pw===sysPw){onLogin()}
      else{setErr(true);setTimeout(()=>setErr(false),1500)}
    }catch(e){
      // Offline fallback
      if(pw==='kosdaq2026'){onLogin()}
      else{setErr(true);setTimeout(()=>setErr(false),1500)}
    }finally{setLoading(false)}
  };

  return(
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-700 to-purple-800">
      <div className="bg-white rounded-2xl p-10 shadow-2xl w-full max-w-sm">
        <div className="text-center mb-8">
          <div className="text-4xl mb-2">ğŸ¢</div>
          <h1 className="text-xl font-bold">ì½”ìŠ¤ë‹¥í˜‘íšŒ QR ì¶œì„ì‹œìŠ¤í…œ</h1>
          <p className="text-sm text-gray-500 mt-1">v4.0 â€” ê´€ë¦¬ì ë¡œê·¸ì¸</p>
        </div>
        <input type="password" className="w-full px-4 py-3 border rounded-lg text-lg mb-3" placeholder="ë¹„ë°€ë²ˆí˜¸" value={pw} onChange={e=>setPw(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')handleLogin()}} autoFocus disabled={loading}/>
        {err&&<p className="text-red-600 text-sm mb-2 font-semibold">âŒ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤</p>}
        <button className="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2" onClick={handleLogin} disabled={loading}>
          {loading?<><Spinner/> í™•ì¸ ì¤‘...</>:'ë¡œê·¸ì¸'}
        </button>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Dashboard
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function Dashboard({trainings,participants,cards,attendance,getStats,selectTraining,showToast,loadTrainings}){
  const [showCreate,setShowCreate]=useState(false);
  const [creating,setCreating]=useState(false);
  const globalTotal=participants.length;
  const globalCert=participants.filter(p=>p.certificateIssued).length;

  const createTraining=async(form)=>{
    setCreating(true);
    try{
      const res=await apiPost({
        action:'addTraining',
        ì—°ìˆ˜ëª…:form.name,
        ì‹œì‘ì¼:form.startDate,
        ì¢…ë£Œì¼:form.endDate||form.startDate,
        ì¼ìˆ˜:form.days,
        ì˜¤ì „ì‹œì‘:form.amStart||'09:00',
        ì˜¤í›„ì‹œì‘:form.pmStart||'13:00',
        /* ì§€ê°ê¸°ì¤€ ì œê±° */
        ì„¤ë¬¸URL:form.surveyUrl||'',
      });
      if(res.status==='ok'){
        showToast(`âœ… "${form.name}" ì—°ìˆ˜ ìƒì„±`);
        setShowCreate(false);
        await loadTrainings();
      }else{
        showToast(`âŒ ${res.message||'ìƒì„± ì‹¤íŒ¨'}`,'err');
      }
    }catch(e){
      showToast('âŒ ì—°ìˆ˜ ìƒì„± ì‹¤íŒ¨ (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜)','err');
    }finally{setCreating(false)}
  };

  const [searchQ,setSearchQ]=useState('');
  const [statusFilter,setStatusFilter]=useState('all');
  const activeTrainings=trainings.filter(t=>t.status==='active');
  const preparingList=trainings.filter(t=>t.status==='preparing');
  const filteredTrainings=trainings.filter(t=>{
    if(statusFilter!=='all'&&t.status!==statusFilter)return false;
    if(searchQ&&!t.name.includes(searchQ))return false;
    return true;
  });

  return(
    <div>
      <h1 className="text-2xl font-bold mb-5">ğŸ“‹ ì—°ìˆ˜ ê´€ë¦¬</h1>
      {/* ì§„í–‰ ì¤‘ì¸ ì—°ìˆ˜ ë¹ ë¥¸ ì§„ì… */}
      {activeTrainings.length>0&&<div className="mb-5">
        <h2 className="text-sm font-semibold text-gray-500 mb-2">ğŸ”´ ì§„í–‰ ì¤‘</h2>
        <div className="grid md:grid-cols-2 gap-3">
          {activeTrainings.map(t=>{const s=getStats(t.id);return(
            <div key={t.id} className="bg-green-50 border-2 border-green-400 rounded-xl p-4 cursor-pointer hover:-translate-y-0.5 transition-all" onClick={()=>selectTraining(t.id)}>
              <div className="flex justify-between items-center">
                <div><div className="font-bold text-lg">{t.name}</div><div className="text-xs text-gray-500">{t.startDate} ~ {t.endDate} Â· {t.days}ì¼</div></div>
                <div className="text-right"><div className="text-2xl font-bold text-green-700">{s.total}ëª…</div><div className="text-xs text-gray-500">ì°¸ê°€ì</div></div>
              </div>
            </div>
          )})}
        </div>
      </div>}
      {/* ì¤€ë¹„ì¤‘ ì—°ìˆ˜ */}
      {preparingList.length>0&&<div className="mb-5">
        <h2 className="text-sm font-semibold text-gray-500 mb-2">ğŸ› ï¸ ì¤€ë¹„ì¤‘</h2>
        <div className="grid md:grid-cols-2 gap-3">
          {preparingList.map(t=>{const s=getStats(t.id);return(
            <div key={t.id} className="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 cursor-pointer hover:-translate-y-0.5 transition-all" onClick={()=>selectTraining(t.id)}>
              <div className="flex justify-between items-center">
                <div><div className="font-bold">{t.name}</div><div className="text-xs text-gray-500">{t.startDate} ~ {t.endDate}</div></div>
                <div className="text-right"><div className="text-lg font-bold text-yellow-700">{s.total}ëª…</div></div>
              </div>
            </div>
          )})}
        </div>
      </div>}
      <div className="flex flex-wrap gap-3 items-center justify-between mb-4">
        <div className="flex gap-2 items-center flex-1 min-w-48">
          <input type="search" className="flex-1 px-3 py-2 border rounded-lg text-sm" placeholder="ğŸ” ì—°ìˆ˜ëª… ê²€ìƒ‰..." value={searchQ} onChange={e=>setSearchQ(e.target.value)}/>
          <select className="px-3 py-2 border rounded-lg text-sm" value={statusFilter} onChange={e=>setStatusFilter(e.target.value)}>
            <option value="all">ì „ì²´</option>
            <option value="active">ì§„í–‰ì¤‘</option>
            <option value="preparing">ì¤€ë¹„ì¤‘</option>
            <option value="completed">ì™„ë£Œ</option>
          </select>
        </div>
        <div className="flex gap-2">
          <button className="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold text-sm hover:bg-blue-700" onClick={()=>setShowCreate(true)}>â• ìƒˆ ì—°ìˆ˜</button>
          <button className="px-4 py-2 border rounded-lg text-sm font-semibold hover:bg-gray-50" onClick={()=>loadTrainings().then(()=>showToast('ğŸ”„ ìƒˆë¡œê³ ì¹¨'))}>ğŸ”„</button>
        </div>
      </div>
      {filteredTrainings.length===0&&<div className="bg-white rounded-xl p-12 text-center text-gray-400"><div className="text-5xl mb-3">ğŸ“‹</div><p>{searchQ||statusFilter!=='all'?'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.':'ë“±ë¡ëœ ì—°ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.'}<br/>{!searchQ&&statusFilter==='all'&&'ìƒˆ ì—°ìˆ˜ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!'}</p></div>}
      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        {filteredTrainings.map(t=>{
          const s=getStats(t.id);
          return(
            <div key={t.id} className="bg-white rounded-xl p-5 shadow-sm border-2 border-transparent hover:border-blue-500 cursor-pointer transition-all hover:-translate-y-0.5" onClick={()=>selectTraining(t.id)}>
              <div className="flex justify-between items-start mb-2">
                <div>
                  <div className="font-bold">{t.name}</div>
                  <div className="text-xs text-gray-500 mt-1">{t.startDate} ~ {t.endDate} Â· {t.days}ì¼</div>
                </div>
                <span className={`text-xs px-2 py-1 rounded-full font-semibold ${t.status==='active'?'bg-green-100 text-green-800':t.status==='preparing'?'bg-yellow-100 text-yellow-800':'bg-gray-100 text-gray-600'}`}>{t.status==='active'?'ì§„í–‰ì¤‘':t.status==='preparing'?'ì¤€ë¹„ì¤‘':'ì™„ë£Œ'}</span>
              </div>
              <div className="text-sm text-gray-600">ğŸ‘¥ ì°¸ê°€ì <strong>{s.total}ëª…</strong></div>
            </div>
          );
        })}
      </div>
      {showCreate&&<CreateModal onClose={()=>setShowCreate(false)} onCreate={createTraining} creating={creating}/>}
    </div>
  );
}

function StatCard({title,value,icon,color}){
  const colors={blue:'text-blue-600',green:'text-green-600',red:'text-red-600',yellow:'text-yellow-600'};
  return(
    <div className="bg-white rounded-xl p-4 shadow-sm">
      <div className="text-xs text-gray-500 font-semibold">{icon} {title}</div>
      <div className={`text-3xl font-bold mt-1 ${colors[color]||'text-gray-900'}`}>{value}</div>
    </div>
  );
}

function CreateModal({onClose,onCreate,creating}){
  const [name,setName]=useState('');
  const [days,setDays]=useState(1);
  const [startDate,setStartDate]=useState('');
  const [amStart,setAmStart]=useState('09:00');
  const [pmStart,setPmStart]=useState('13:00');
  const [lateMinutes,setLateMinutes]=useState(10);

  const calcEndDate=()=>{
    if(!startDate||days<=1)return startDate;
    const d=new Date(startDate);let added=0;
    while(added<days-1){d.setDate(d.getDate()+1);if(d.getDay()!==0&&d.getDay()!==6)added++}
    return d.toISOString().slice(0,10);
  };

  return(
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={onClose}>
      <div className="bg-white rounded-xl p-8 max-w-md w-full mx-4" onClick={e=>e.stopPropagation()}>
        <h2 className="text-lg font-bold mb-5">â• ìƒˆ ì—°ìˆ˜ ë§Œë“¤ê¸°</h2>
        <div className="mb-4"><label className="text-sm font-semibold block mb-1">ì—°ìˆ˜ëª… *</label><input className="w-full px-3 py-2 border rounded-lg" value={name} onChange={e=>setName(e.target.value)} placeholder='ì˜ˆ: "ì„ì› â€“ ì˜¤í”„ë¼ì¸ ì œ1ì°¨"'/></div>
        <div className="mb-4"><label className="text-sm font-semibold block mb-2">ì—°ìˆ˜ ì¼ìˆ˜ *</label>
          <div className="flex gap-2">{[1,2,3,4,5].map(d=><button key={d} className={`px-4 py-2 rounded-lg font-semibold text-sm ${days===d?'bg-blue-600 text-white':'border hover:bg-gray-50'}`} onClick={()=>setDays(d)}>{d}ì¼</button>)}</div>
        </div>
        <div className="mb-4"><label className="text-sm font-semibold block mb-1">ì‹œì‘ì¼ *</label><input type="date" className="w-full px-3 py-2 border rounded-lg" value={startDate} onChange={e=>setStartDate(e.target.value)}/>
          {startDate&&<div className="mt-2 text-sm text-blue-600 font-semibold">ğŸ“… {startDate} ~ {calcEndDate()} ({days}ì¼ê°„)</div>}
        </div>
        <div className="grid grid-cols-3 gap-3 mb-6">
          <div><label className="text-xs font-semibold block mb-1">ì˜¤ì „ ì‹œì‘</label><input type="time" className="w-full px-2 py-2 border rounded-lg text-sm" value={amStart} onChange={e=>setAmStart(e.target.value)}/></div>
          <div><label className="text-xs font-semibold block mb-1">ì˜¤í›„ ì‹œì‘</label><input type="time" className="w-full px-2 py-2 border rounded-lg text-sm" value={pmStart} onChange={e=>setPmStart(e.target.value)}/></div>
          {/* ì§€ê°ê¸°ì¤€ ì œê±° */}
        </div>
        <div className="flex gap-3 justify-end">
          <button className="px-4 py-2 border rounded-lg text-sm" onClick={onClose}>ì·¨ì†Œ</button>
          <button className="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2" disabled={!name.trim()||!startDate||creating} onClick={()=>onCreate({name:name.trim(),days,startDate,endDate:calcEndDate(),amStart,pmStart})}>
            {creating?<><Spinner/> ìƒì„± ì¤‘...</>:'âœ… ìƒì„±'}
          </button>
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Training Dashboard
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function TrainingDash({training,participants,cards,attendanceRecords,showToast,getStats}){
  const s=getStats(training.id);

  const dayStats=Array.from({length:training.days},(_,i)=>{
    const d=i+1;
    const am=attendanceRecords.filter(a=>a.day===d&&a.session==='AM').length;
    const pm=attendanceRecords.filter(a=>a.day===d&&a.session==='PM').length;
    return{day:d,am,pm,rate:participants.length?Math.round((am+pm)/(participants.length*2)*100):0};
  });

  return(
    <div>
      <h1 className="text-2xl font-bold mb-5">ğŸ“Š ì—°ìˆ˜ ëŒ€ì‹œë³´ë“œ</h1>
      <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl p-6 mb-5">
        <div className="text-sm text-blue-200">í˜„ì¬ ì—°ìˆ˜</div>
        <div className="text-2xl font-bold mt-1">{training.name}</div>
        <div className="text-sm text-blue-200 mt-1">{training.startDate} ~ {training.endDate} Â· {training.days}ì¼ê°„</div>
        <div className="mt-3 flex gap-2">
          <span className={`text-xs px-3 py-1 rounded-full font-semibold ${training.status==='active'?'bg-green-400/30 text-green-100':training.status==='preparing'?'bg-yellow-400/30 text-yellow-100':'bg-gray-400/30 text-gray-200'}`}>{training.status==='active'?'ì§„í–‰ì¤‘':training.status==='preparing'?'ì¤€ë¹„ì¤‘':'ì™„ë£Œ'}</span>
        </div>
      </div>
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
        <StatCard title="ì°¸ê°€ì" value={s.total} icon="ğŸ‘¥"/>
        <StatCard title="ë§¤í•‘ë¥ " value={`${s.mappingRate}%`} icon="ğŸ”—" color="blue"/>
        <StatCard title="ì¶œì„ë¥ " value={`${s.attendanceRate}%`} icon="âœ…" color="green"/>
        <StatCard title="ìˆ˜ë£Œìœ¨" value={`${s.certRate}%`} icon="ğŸ“" color="green"/>
      </div>
      <div className="bg-white rounded-xl p-5 shadow-sm">
        <h3 className="text-sm font-semibold text-gray-500 mb-3">ì¼ë³„ ì¶œì„ í˜„í™©</h3>
        <table className="w-full text-sm"><thead><tr className="text-xs text-gray-500 uppercase"><th className="text-left py-2">ì¼ì°¨</th><th>ì˜¤ì „</th><th>ì˜¤í›„</th><th>ì¶œì„ë¥ </th></tr></thead>
          <tbody>{dayStats.map(ds=>(
            <tr key={ds.day} className="border-t"><td className="py-2 font-semibold">{ds.day}ì¼ì°¨</td><td className="text-center">{ds.am}/{s.total}</td><td className="text-center">{ds.pm}/{s.total}</td>
              <td><div className="flex items-center gap-2"><div className="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden"><div className="h-full rounded-full" style={{width:`${ds.rate}%`,background:ds.rate>70?'#22c55e':ds.rate>40?'#eab308':'#ef4444'}}/></div><span className="text-xs w-8">{ds.rate}%</span></div></td></tr>
          ))}</tbody>
        </table>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Upload
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function Upload({training,participants,showToast,loadParticipants}){
  const [showQR,setShowQR]=useState(false);
  const [uploading,setUploading]=useState(false);
  const fileRef=useRef();

  const handleExcel=async(e)=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=async(ev)=>{
      try{
        const wb=XLSX.read(ev.target.result,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        let rows=XLSX.utils.sheet_to_json(ws);
        // ìˆ˜ê°•ìë£Œ ì—‘ì…€: 2í–‰ì´ ë¶€ì œëª©((ìˆ˜ê°•ìì •ë³´) ë“±)ì´ë©´ ì œê±°
        if(rows.length&&rows[0]){const v=Object.values(rows[0]).join('');if(v.includes('ìˆ˜ê°•ìì •ë³´')||v.includes('ì „ìê³„ì‚°ì„œ'))rows=rows.slice(1)}
        if(!rows.length){showToast('âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤','err');return}
        const newPs=rows.map(r=>{
          const name=r['ì´ë¦„']||r['name']||r['ì„±ëª…']||'';
          const company=r['íšŒì‚¬']||r['íšŒì‚¬ëª…']||r['ì†Œì†ì‚¬']||r['ì†Œì†']||r['company']||'';
          const position=r['ì§ê¸‰']||r['position']||r['ì§ìœ„']||'';
          const phone=r['ì—°ë½ì²˜']||r['ì—°ë½ì²˜(ë¬´ì„ )']||r['ì „í™”ë²ˆí˜¸']||r['phone']||r['í•¸ë“œí°']||'';
          const email=r['ì´ë©”ì¼']||r['email']||'';
          const manager=r['ë‹´ë‹¹ì']||'';
          if(!name)return null;
          // ìˆ˜ê°•ìë£Œ: ì·¨ì†Œ ìƒíƒœ ê±´ë„ˆë›°ê¸°
          const status=r['ì—°ìˆ˜ìƒíƒœ']||'';
          if(status==='ì·¨ì†Œ')return null;
          return{ì´ë¦„:name.toString().trim(),íšŒì‚¬:company.toString().trim(),ì§ê¸‰:position.toString().trim(),ì—°ë½ì²˜:phone.toString().trim(),ì´ë©”ì¼:email.toString().trim(),ë‹´ë‹¹ì:manager.toString().trim()};
        }).filter(Boolean);
        if(!newPs.length){showToast('âŒ ìœ íš¨í•œ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤ (ì´ë¦„ ì»¬ëŸ¼ í•„ìš”)','err');return}

        setUploading(true);
        const res=await apiPost({
          action:'uploadParticipants',
          tid:training.id,
          participants:newPs,
        });
        if(res.status==='ok'){
          showToast(`âœ… ${newPs.length}ëª… ì—…ë¡œë“œ ì™„ë£Œ!`);
          await loadParticipants(training.id);
        }else{
          showToast(`âŒ ${res.message||'ì—…ë¡œë“œ ì‹¤íŒ¨'}`,'err');
        }
      }catch(err){showToast('âŒ ì˜¤ë¥˜: '+err.message,'err')}
      finally{setUploading(false)}
    };
    reader.readAsArrayBuffer(file);
    e.target.value='';
  };

  const addManual=async()=>{
    const name=prompt('ì°¸ê°€ì ì´ë¦„');if(!name)return;
    const company=prompt('íšŒì‚¬')||'';
    const position=prompt('ì§ê¸‰')||'';
    const phone=prompt('ì—°ë½ì²˜')||'';
    try{
      const res=await apiPost({
        action:'uploadParticipants',
        tid:training.id,
        participants:[{ì´ë¦„:name.trim(),íšŒì‚¬:company.trim(),ì§ê¸‰:position.trim(),ì—°ë½ì²˜:phone.trim(),ì´ë©”ì¼:'',ë‹´ë‹¹ì:''}],
      });
      if(res.status==='ok'){
        showToast(`âœ… ${name} ë“±ë¡`);
        await loadParticipants(training.id);
      }else showToast(`âŒ ${res.message||'ë“±ë¡ ì‹¤íŒ¨'}`,'err');
    }catch(e){showToast('âŒ ë“±ë¡ ì‹¤íŒ¨','err')}
  };

  return(
    <div>
      <h1 className="text-2xl font-bold mb-5">ğŸ“ ëª…ë‹¨ ì—…ë¡œë“œ & QR ìƒì„±</h1>
      <div className="bg-white rounded-xl p-6 mb-4 shadow-sm">
        <h3 className="text-sm font-semibold text-gray-500 mb-3">ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h3>
        <div className={`border-2 border-dashed rounded-xl p-10 text-center cursor-pointer hover:border-blue-400 transition ${uploading?'border-blue-400 bg-blue-50':'border-gray-300'}`} onClick={()=>!uploading&&fileRef.current?.click()}>
          {uploading?<><Spinner size="lg"/><div className="mt-3">ì—…ë¡œë“œ ì¤‘...</div></>:<>
            <div className="text-4xl mb-2">ğŸ“„</div>
            <div>í´ë¦­í•˜ì—¬ ì—‘ì…€ íŒŒì¼ ì„ íƒ</div>
            <div className="text-sm text-gray-500 mt-1">.xlsx ì§€ì› | ìˆ˜ê°•ìë£Œ ì—‘ì…€ ê·¸ëŒ€ë¡œ ì—…ë¡œë“œ ê°€ëŠ¥ (ì·¨ì†Œ ê±´ ìë™ ì œì™¸)</div>
          </>}
        </div>
        <input ref={fileRef} type="file" accept=".xlsx,.xls,.csv" className="hidden" onChange={handleExcel}/>
      </div>
      <div className="flex flex-wrap gap-3 items-center justify-between mb-4">
        <div className="font-semibold">ë“±ë¡ëœ ì°¸ê°€ì: {participants.length}ëª…</div>
        <div className="flex gap-2">
          <button className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold" onClick={addManual}>â• ìˆ˜ë™ ì¶”ê°€</button>
          {participants.length>0&&<button className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-semibold" onClick={()=>setShowQR(true)}>ğŸ”² QRì½”ë“œ ë³´ê¸°</button>}
          <button className="px-4 py-2 border rounded-lg text-sm font-semibold hover:bg-gray-50" onClick={()=>loadParticipants(training.id).then(()=>showToast('ğŸ”„ ìƒˆë¡œê³ ì¹¨'))}>ğŸ”„</button>
        </div>
      </div>
      {participants.length>0&&<div className="bg-white rounded-xl shadow-sm overflow-x-auto">
        <table className="w-full text-sm"><thead><tr className="text-xs text-gray-500 uppercase bg-gray-50"><th className="text-left p-3">#</th><th className="text-left p-3">ì´ë¦„</th><th className="text-left p-3">íšŒì‚¬</th><th className="text-left p-3">ì§ê¸‰</th><th className="text-left p-3">ì—°ë½ì²˜</th><th className="text-left p-3">QR í† í°</th></tr></thead>
          <tbody>{participants.map((p,i)=>(
            <tr key={p.id} className="border-t hover:bg-gray-50"><td className="p-3">{i+1}</td><td className="p-3 font-semibold">{p.name}</td><td className="p-3">{p.company}</td><td className="p-3">{p.position}</td><td className="p-3">{p.phone}</td>
              <td className="p-3"><code className="text-xs bg-gray-100 px-2 py-1 rounded">{p.qrCode}</code></td></tr>
          ))}</tbody>
        </table>
      </div>}
      {showQR&&<QRModal participants={participants} onClose={()=>setShowQR(false)}/>}
    </div>
  );
}

function QRModal({participants,onClose}){
  return(
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={onClose}>
      <div className="bg-white rounded-xl p-6 max-w-3xl w-full mx-4 max-h-[80vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-lg font-bold">ğŸ”² ì°¸ê°€ì QRì½”ë“œ</h2>
          <div className="flex gap-2">
            <button className="px-3 py-1 border rounded text-sm" onClick={()=>window.print()}>ğŸ–¨ï¸ ì¸ì‡„</button>
            <button className="px-3 py-1 border rounded text-sm" onClick={onClose}>âœ• ë‹«ê¸°</button>
          </div>
        </div>
        <div className="grid grid-cols-3 md:grid-cols-4 gap-3">
          {participants.map(p=><QRCard key={p.id} data={p}/>)}
        </div>
      </div>
    </div>
  );
}

function QRCard({data}){
  const ref=useRef();
  useEffect(()=>{if(ref.current&&window.QRCode)QRCode.toCanvas(ref.current,data.qrCode,{width:100,margin:1}).catch(()=>{});},[data.qrCode]);
  return(
    <div className="text-center p-3 border rounded-lg">
      <canvas ref={ref} className="mx-auto" style={{maxWidth:90,maxHeight:90}}/>
      <p className="text-xs font-bold mt-1">{data.name}</p>
      <p className="text-xs text-gray-500">{data.company}</p>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Mapping
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function MappingPage({training,participants,cards,showToast,showScanResult,loadCards,loadParticipants}){
  const [pQr,setPQr]=useState('');
  const [cQr,setCQr]=useState('');
  const [showManual,setShowManual]=useState(false);
  const [mapping,setMapping]=useState(false);
  const pRef=useRef();
  const cRef=useRef();

  const found=useMemo(()=>{
    if(!pQr)return null;
    const p=participants.find(x=>x.qrCode===pQr);
    return p||'notfound';
  },[pQr,participants]);

  useFocusLock(pRef,!found||found==='notfound');
  useEffect(()=>{if(found&&found!=='notfound')setTimeout(()=>cRef.current?.focus(),50)},[found]);

  const doMap=async()=>{
    if(!found||found==='notfound'||!cQr||mapping)return;
    setMapping(true);
    try{
      const res=await apiPost({action:'mapCard',cardId:cQr,participantId:found.id});
      if(res.status==='ok'){
        showScanResult('success','âœ…',found.name,`${cQr} ë§¤í•‘ ì™„ë£Œ!`);
        await loadCards();
      }else{
        showScanResult('error','âŒ','ë§¤í•‘ ì‹¤íŒ¨',res.error||res.message||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
      }
    }catch(e){
      showScanResult('error','âŒ','ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜','ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
    }finally{
      setMapping(false);
      setTimeout(()=>{setPQr('');setCQr('');pRef.current?.focus()},1000);
    }
  };

  const manualSelect=(p)=>{setPQr(p.qrCode);setShowManual(false)};
  const mappedCount=cards.filter(c=>c.status!=='available'&&participants.some(p=>p.id===c.participantId)).length;

  return(
    <div>
      <h1 className="text-2xl font-bold mb-5">ğŸ”— ë§¤í•‘ â€” ì°¸ê°€ì â†” ì¶œì…ì¹´ë“œ</h1>
      <div className="grid grid-cols-3 gap-3 mb-4">
        <StatCard title="ì´ ì¸ì›" value={participants.length} icon="ğŸ‘¥"/>
        <StatCard title="ë§¤í•‘ ì™„ë£Œ" value={mappedCount} icon="âœ…" color="green"/>
        <StatCard title="ëŒ€ê¸° ì¤‘" value={participants.length-mappedCount} icon="â³" color="yellow"/>
      </div>
      <div className="bg-yellow-50 border border-yellow-300 rounded-xl p-4 mb-4 text-sm">ğŸ’¡ <strong>ìš´ì˜ ì•ˆë‚´:</strong> ìŠ¤ìºë„ˆ 1ë¡œ ì°¸ê°€ì QR â†’ ìŠ¤ìºë„ˆ 2ë¡œ ì¶œì…ì¹´ë“œ QR ìŠ¤ìº”. Enterë¡œ ë§¤í•‘ í™•ì •.</div>
      <div className="bg-blue-50 border border-blue-300 rounded-xl p-3 mb-4 text-sm">ğŸ’³ <strong>ì¶œì…ì¹´ë“œ ê´€ë¦¬:</strong> ì¹´ë“œ ë“±ë¡/ì‚­ì œëŠ” <a href="https://docs.google.com/spreadsheets/d/1cW8PARwBvDTz4Y6IXak85o-ZBRtxo_KhS1nlWy-tzzA" target="_blank" className="text-blue-600 underline">êµ¬ê¸€ ì‹œíŠ¸</a>ì—ì„œ ì§ì ‘ ê´€ë¦¬í•©ë‹ˆë‹¤.</div>
      <div className="grid md:grid-cols-2 gap-4 mb-4">
        <div className={`border-2 border-dashed rounded-xl p-6 text-center transition ${found&&found!=='notfound'?'border-green-500 bg-green-50':pQr?'border-blue-500 bg-blue-50':'border-gray-300'}`}>
          <div className="text-4xl mb-2">ğŸ“±</div>
          <div className="font-bold mb-2">ìŠ¤ìºë„ˆ 1 â€” ì°¸ê°€ì QR</div>
          <input ref={pRef} type="text" className="scanner-input w-full px-4 py-3 border rounded-lg" value={pQr} onChange={e=>setPQr(e.target.value.trim())} onKeyDown={e=>{if(e.key==='Enter'&&found&&found!=='notfound')cRef.current?.focus()}} placeholder="ì°¸ê°€ì QR ìŠ¤ìº”..." autoFocus/>
          <div className="mt-2 flex gap-2 justify-center">
            <button className="px-3 py-1 border rounded text-xs" onClick={()=>setShowManual(true)}>ğŸ” ìˆ˜ë™ ê²€ìƒ‰</button>
          </div>
          {found&&found!=='notfound'&&<div className="mt-3 bg-white p-3 rounded-lg text-left"><div className="text-green-600 font-bold">âœ… ë³¸ì¸ í™•ì¸</div><div className="text-lg font-bold">{found.name} Â· {found.company}</div></div>}
          {found==='notfound'&&<div className="mt-2 text-red-600 font-bold">âŒ ë¯¸ë“±ë¡ QR</div>}
        </div>
        <div className={`border-2 border-dashed rounded-xl p-6 text-center transition ${cQr?'border-blue-500 bg-blue-50':'border-gray-300'}`}>
          <div className="text-4xl mb-2">ğŸ’³</div>
          <div className="font-bold mb-2">ìŠ¤ìºë„ˆ 2 â€” ì¶œì…ì¹´ë“œ QR</div>
          <input ref={cRef} type="text" className="scanner-input w-full px-4 py-3 border rounded-lg" value={cQr} onChange={e=>setCQr(e.target.value.trim())} onKeyDown={e=>{if(e.key==='Enter')doMap()}} placeholder="ì¹´ë“œ QR ìŠ¤ìº”..."/>
        </div>
      </div>
      <div className="text-center mb-5">
        <button className="px-8 py-4 bg-green-600 text-white text-xl rounded-xl font-bold hover:bg-green-700 disabled:opacity-50 flex items-center justify-center gap-2 mx-auto" onClick={doMap} disabled={!found||found==='notfound'||!cQr||mapping}>
          {mapping?<><Spinner/> ë§¤í•‘ ì¤‘...</>:'ğŸ”— ë§¤í•‘ í™•ì • (Enter)'}
        </button>
      </div>
      <div className="bg-white rounded-xl p-5 shadow-sm">
        <div className="flex justify-between items-center mb-3">
          <h3 className="text-sm font-semibold text-gray-500">ë§¤í•‘ ë‚´ì—­</h3>
          <button className="text-xs border px-2 py-1 rounded hover:bg-gray-50" onClick={()=>loadCards().then(()=>showToast('ğŸ”„ ìƒˆë¡œê³ ì¹¨'))}>ğŸ”„</button>
        </div>
        <table className="w-full text-sm"><thead><tr className="text-xs text-gray-500 uppercase bg-gray-50"><th className="text-left p-2">ì°¸ê°€ì</th><th className="text-left p-2">ì†Œì†</th><th className="text-left p-2">ì¹´ë“œ QR</th><th className="p-2">ìƒíƒœ</th></tr></thead>
          <tbody>{participants.map(p=>{
            const c=cards.find(c=>c.participantId===p.id&&c.status!=='available');
            return <tr key={p.id} className="border-t"><td className="p-2 font-semibold">{p.name}</td><td className="p-2 text-gray-500">{p.company}</td><td className="p-2">{c?<code className="text-xs bg-gray-100 px-2 py-0.5 rounded">{c.qrCode}</code>:'-'}</td><td className="p-2 text-center">{c?<span className="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">ë§¤í•‘</span>:<span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">ëŒ€ê¸°</span>}</td></tr>;
          })}</tbody>
        </table>
      </div>
      {showManual&&<ManualSearch participants={participants} onSelect={manualSelect} onClose={()=>setShowManual(false)}/>}
    </div>
  );
}

/* â”€â”€â”€ Manual Search â”€â”€â”€ */
function ManualSearch({participants,onSelect,onClose,title}){
  const [q,setQ]=useState('');
  const filtered=q.length>=1?participants.filter(p=>p.name.includes(q)||p.company.includes(q)):[];
  return(
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={onClose}>
      <div className="bg-white rounded-xl p-6 max-w-lg w-full mx-4 max-h-[80vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-lg font-bold">{title||'ğŸ” ìˆ˜ë™ ê²€ìƒ‰'}</h2>
          <button className="px-3 py-1 border rounded text-sm" onClick={onClose}>âœ•</button>
        </div>
        <input type="text" className="w-full px-4 py-3 border rounded-lg text-lg mb-3" placeholder="ì´ë¦„ ë˜ëŠ” ì†Œì† ê²€ìƒ‰..." value={q} onChange={e=>setQ(e.target.value)} autoFocus/>
        {q.length>=1&&filtered.length===0&&<p className="text-center text-gray-400 py-4">ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ</p>}
        {filtered.slice(0,10).map(p=>(
          <div key={p.id} className="flex items-center justify-between p-3 border rounded-lg mt-2 cursor-pointer hover:border-blue-500 hover:bg-blue-50" onClick={()=>onSelect(p)}>
            <div><div className="font-bold">{p.name}</div><div className="text-sm text-gray-500">{p.company}</div></div>
            <button className="px-3 py-1 bg-green-600 text-white rounded text-sm">ì„ íƒ</button>
          </div>
        ))}
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Attendance
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function AttendancePage({training,participants,attendanceRecords,showToast,showScanResult,cards,loadAttendance,setAttendance,setCards,loadCards}){
  const [day,setDay]=useState(1);
  const [session,setSess]=useState('AM');
  const [qrInput,setQr]=useState('');
  const [showManual,setShowManual]=useState(false);
  const [scanning,setScanning]=useState(false);
  const inputRef=useRef();
  const scanTimerRef=useRef(null);

  useFocusLock(inputRef,!showManual&&!cardMappingTarget);

  // ì¹´ë“œ ë§¤í•‘ ëŒ€ê¸° ìƒíƒœ: ì¶œì„ í›„ ì¹´ë“œ ìŠ¤ìº” ëŒ€ê¸°
  const [cardMappingTarget,setCardMappingTarget]=useState(null); // ì¶œì„ ì™„ë£Œëœ ì°¸ê°€ì â€” ì¹´ë“œ ìŠ¤ìº” ëŒ€ê¸° ì¤‘

  const processAttendance=async(target,method='scanner')=>{
    const existing=attendanceRecords.find(a=>a.participantId===target.id&&a.day===day&&a.session===session);
    if(existing){showScanResult('duplicate','âš ï¸',target.name,`ì´ë¯¸ ì¶œì„ (${new Date(existing.checkedAt).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'})})`);setQr('');return}

    // ë‚™ê´€ì  UI: ì¦‰ì‹œ ì¶œì„ í‘œì‹œ
    const nowTime=new Date();
    const optimisticAtt={id:'opt_'+Date.now(),participantId:target.id,trainingId:training.id,day,session,checkedAt:nowTime.toISOString(),method,late:false};
    setAttendance(prev=>[...prev,optimisticAtt]);
    setQr('');

    // ì¹´ë“œ ë§¤í•‘ ì—¬ë¶€ í™•ì¸ â€” ë§¤í•‘ ì•ˆ ëœ ì°¸ê°€ìë©´ ì¹´ë“œ ìŠ¤ìº” ìœ ë„ (1.5ì´ˆ ë”œë ˆì´: ìŠ¤ìºë„ˆ ì†¡ì¶œ ì™„ë£Œ ëŒ€ê¸°)
    const hasCard=cards.some(c=>c.participantId===target.id&&c.status==='mapped');
    if(!hasCard){
      showScanResult('success','âœ…',target.name,`ì¶œì„ ì™„ë£Œ â€” 3ì´ˆ í›„ ì¹´ë“œ ìŠ¤ìº”`);
      setTimeout(()=>{setCardMappingTarget(target);setQr('')},3000);
    }else{
      showScanResult('success','âœ…',target.name,`${day}ì¼ì°¨ ${session==='AM'?'ì˜¤ì „':'ì˜¤í›„'} ì¶œì„`);
    }

    // ë°±ê·¸ë¼ìš´ë“œ ì„œë²„ ì €ì¥
    try{
      const res=await apiPost({action:'scan',qrCode:target.qrCode,day,session,method});
      if(res.status==='ok'){
        loadAttendance(training.id,day);
      }else{
        setAttendance(prev=>prev.filter(a=>a.id!==optimisticAtt.id));
        showScanResult('error','âŒ',target.name,res.error||res.message||'ì„œë²„ ì €ì¥ ì‹¤íŒ¨');
        setCardMappingTarget(null);
      }
    }catch(e){
      showToast('âš ï¸ ì˜¤í”„ë¼ì¸: '+target.name+' ì¶œì„ì€ ë¡œì»¬ ì €ì¥ë¨');
    }
  };

  // ì¹´ë“œ ë§¤í•‘ ì²˜ë¦¬ (ì¶œì„ ì§í›„ ì¹´ë“œ ìŠ¤ìº”)
  const processCardMapping=async(cardCode)=>{
    if(!cardMappingTarget)return;
    const target=cardMappingTarget;
    setCardMappingTarget(null);
    showScanResult('success','âœ…',target.name,'ì¶œì„ ì™„ë£Œ + ì¹´ë“œ ë§¤í•‘');
    setQr('');
    // ë¡œì»¬ cards ìºì‹œ ì¦‰ì‹œ ê°±ì‹  (ë‚™ê´€ì )
    const optimisticCard={id:'optC_'+Date.now(),qrCode:cardCode,status:'mapped',participantId:target.id,participantName:target.name,mappedAt:new Date().toISOString()};
    setCards(prev=>[...prev,optimisticCard]);
    // ë°±ê·¸ë¼ìš´ë“œ ë§¤í•‘
    try{
      await apiPost({action:'mapCard',cardId:cardCode,participantId:target.id});
      loadCards();
      showToast(`ğŸ”— ${target.name} â† ${cardCode} ë§¤í•‘ ì™„ë£Œ`);
    }catch(e){
      setCards(prev=>prev.filter(c=>c.id!==optimisticCard.id));
      showToast('âš ï¸ ì¹´ë“œ ë§¤í•‘ ì‹¤íŒ¨: '+e.message);
    }
  };

  const processQR=async(rawCode)=>{
    const code=rawCode.replace(/[\r\n\t]/g,'').trim();
    console.log('[QR] input:', JSON.stringify(code), 'len:', code.length);
    console.log('[QR] participants sample qrCode:', participants[0]?.qrCode);

    // ì¹´ë“œ ë§¤í•‘ ëŒ€ê¸° ì¤‘ì´ë©´ ì¹´ë“œ ë§¤í•‘ìœ¼ë¡œ ì²˜ë¦¬
    if(cardMappingTarget){
      processCardMapping(code);
      return;
    }

    let target=participants.find(p=>p.qrCode===code||p.qrCode?.toUpperCase()===code.toUpperCase());
    console.log('[QR] participant match:', target?.name||'NONE');
    if(!target){
      // ì¶œì…ì¹´ë“œ QR â†’ ë§¤í•‘ëœ ì¹´ë“œ í™•ì¸ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
      const codeUpper=code.toUpperCase();
      let card=cards.find(c=>(c.qrCode===code||c.qrCode?.toUpperCase()===codeUpper)&&c.status==='mapped');
      console.log('[QR] local card match:', card?.participantId||'NONE');

      // ë¡œì»¬ì— ì—†ìœ¼ë©´ ì„œë²„ì—ì„œ cards ìƒˆë¡œê³ ì¹¨ í›„ ì¬ì‹œë„
      if(!card){
        try{await loadCards()}catch(e){}
        // loadCards ë¹„ë™ê¸°ì´ë¯€ë¡œ ì§ì ‘ ì„œë²„ scan í˜¸ì¶œ
      }

      if(card){target=participants.find(p=>p.id===card.participantId);}

      if(!target){
        // ì„œë²„ scan API (ì¶œì…ì¹´ë“œ+ì°¸ê°€ì ëª¨ë‘ ê²€ìƒ‰)
        setScanning(true);
        try{
          const res=await apiPost({action:'scan',qrCode:code,day,session,method:'scanner'});
          if(res.status==='ok'){
            const d=res.data||res;
            const pName=d.ì´ë¦„||d.name||'';
            const pCompany=d.íšŒì‚¬||d.company||'';
            showScanResult('success','âœ…',pName||'ì¶œì„ ì™„ë£Œ',`${pCompany} Â· ${day}ì¼ì°¨ ${session==='AM'?'ì˜¤ì „':'ì˜¤í›„'}`);
            await loadAttendance(training.id,day);
          }else{
            showScanResult('error','âŒ','ì²˜ë¦¬ ì‹¤íŒ¨',res.error||res.message||'ë¯¸ë“±ë¡ QR');
          }
        }catch(e){
          showScanResult('error','âŒ','ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜','ì„œë²„ ì—°ê²° ì‹¤íŒ¨');
        }finally{setScanning(false);setQr('')}
        return;
      }
    }
    processAttendance(target);
  };

  const present=attendanceRecords.filter(a=>a.day===day&&a.session===session);

  // Load attendance when day changes
  useEffect(()=>{loadAttendance(training.id,day)},[day]);

  return(
    <div>
      <h1 className="text-2xl font-bold mb-5">âœ… ì¶œì„ ì²´í¬</h1>
      <div className="bg-white rounded-xl p-4 mb-4 shadow-sm">
        <div className="flex flex-wrap gap-4 items-center">
          <div>
            <label className="text-xs font-semibold block mb-1">ì¼ì°¨</label>
            <div className="flex gap-2">{Array.from({length:training.days},(_,i)=>i+1).map(d=><button key={d} className={`px-4 py-2 rounded-lg font-semibold text-sm ${day===d?'bg-blue-600 text-white':'border'}`} onClick={()=>setDay(d)}>Day {d}</button>)}</div>
          </div>
          <div>
            <label className="text-xs font-semibold block mb-1">ì‹œê°„ëŒ€</label>
            <div className="flex gap-2">
              <button className={`px-4 py-2 rounded-lg font-semibold text-sm ${session==='AM'?'bg-blue-600 text-white':'border'}`} onClick={()=>setSess('AM')}>â˜€ï¸ ì˜¤ì „</button>
              <button className={`px-4 py-2 rounded-lg font-semibold text-sm ${session==='PM'?'bg-blue-600 text-white':'border'}`} onClick={()=>setSess('PM')}>ğŸŒ™ ì˜¤í›„</button>
            </div>
          </div>
          <div className="ml-auto text-center">
            <div className="text-xs text-gray-500">ì¶œì„ë¥ </div>
            <div className="text-3xl font-bold text-blue-600">{present.length}/{participants.length}</div>
          </div>
        </div>
      </div>
      <div className="grid md:grid-cols-2 gap-4">
        <div>
          <div className="bg-white rounded-xl p-5 shadow-sm mb-4">
            <h3 className="text-sm font-semibold text-gray-500 mb-3">ğŸ“± QR ìŠ¤ìº”</h3>
            <input ref={inputRef} type="text" className="scanner-input w-full px-4 py-3 border rounded-lg" value={qrInput} onChange={e=>{const v=e.target.value;setQr(v);if(scanTimerRef.current)clearTimeout(scanTimerRef.current);const trimmed=v.trim();if(trimmed.length>=10){scanTimerRef.current=setTimeout(()=>{if(!scanning){processQR(trimmed);setQr('')}},400)}}} onKeyDown={e=>{if(e.key==='Enter'){e.preventDefault();const v=qrInput.trim();if(v&&!scanning){if(scanTimerRef.current)clearTimeout(scanTimerRef.current);processQR(v);setQr('')}}}} placeholder="ì¹´ë“œ QR ë˜ëŠ” ì°¸ê°€ì QR ìŠ¤ìº”..." autoFocus/>
            <div className="flex gap-2 mt-3">
              <button className="px-3 py-1 border rounded text-xs" onClick={()=>setShowManual(true)}>ğŸ” ìˆ˜ë™ ê²€ìƒ‰</button>
              <button className="px-3 py-1 border rounded text-xs" onClick={()=>loadAttendance(training.id,day).then(()=>showToast('ğŸ”„ ìƒˆë¡œê³ ì¹¨'))}>ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
          </div>
        </div>
        <div className="bg-white rounded-xl p-5 shadow-sm">
          <h3 className="text-sm font-semibold text-gray-500 mb-3">ì‹¤ì‹œê°„ í˜„í™© ({day}ì¼ì°¨ {session==='AM'?'ì˜¤ì „':'ì˜¤í›„'})</h3>
          <div className="max-h-96 overflow-y-auto">
            <table className="w-full text-sm"><thead><tr className="text-xs text-gray-500 bg-gray-50"><th className="text-left p-2">ì´ë¦„</th><th className="text-left p-2">ì†Œì†</th><th className="p-2">ìƒíƒœ</th><th className="p-2">ì‹œê°</th></tr></thead>
              <tbody>{participants.map(p=>{
                const att=present.find(a=>a.participantId===p.id);
                return <tr key={p.id} className="border-t"><td className="p-2 font-semibold">{p.name}</td><td className="p-2 text-gray-500 text-xs">{p.company}</td>
                  <td className="p-2 text-center">{att?<span className="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">ì¶œì„</span>:<span className="text-xs bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full">ë¯¸ì¶œì„</span>}</td>
                  <td className="p-2 text-center text-xs">{att?new Date(att.checkedAt).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):'-'}</td></tr>;
              })}</tbody>
            </table>
          </div>
        </div>
      </div>
      {showManual&&<ManualSearch participants={participants} title="ìˆ˜ë™ ì¶œì„" onClose={()=>setShowManual(false)} onSelect={p=>{processAttendance(p,'manual');setShowManual(false)}}/>}
      {cardMappingTarget&&<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',zIndex:200,display:'flex',alignItems:'center',justifyContent:'center'}} onClick={()=>{setCardMappingTarget(null);showScanResult('success','âœ…',cardMappingTarget.name,'ì¶œì„ ì™„ë£Œ (ì¹´ë“œ ë§¤í•‘ ê±´ë„ˆëœ€)')}}>
        <div className="bg-white rounded-2xl p-8 shadow-2xl text-center max-w-md mx-4" onClick={e=>e.stopPropagation()}>
          <div className="text-5xl mb-3">ğŸªª</div>
          <div className="text-xl font-bold mb-1">{cardMappingTarget.name}</div>
          <div className="text-sm text-gray-500 mb-4">{cardMappingTarget.company}</div>
          <div className="text-lg font-semibold text-blue-600 mb-2">ì¶œì…ì¹´ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</div>
          <div className="text-sm text-gray-400 mb-4">ì¹´ë“œ QRì„ ìŠ¤ìº”í•˜ë©´ ìë™ ë§¤í•‘ë©ë‹ˆë‹¤</div>
          <input type="text" className="scanner-input w-full px-4 py-3 border rounded-lg text-center mb-4" value={qrInput} onChange={e=>{const v=e.target.value;setQr(v);if(scanTimerRef.current)clearTimeout(scanTimerRef.current);const trimmed=v.trim();if(trimmed.length>=5){scanTimerRef.current=setTimeout(()=>{processCardMapping(trimmed);setQr('')},400)}}} onKeyDown={e=>{if(e.key==='Enter'){e.preventDefault();const v=qrInput.trim();if(v){processCardMapping(v);setQr('')}}}} placeholder="ì¹´ë“œ QR ìŠ¤ìº” ëŒ€ê¸°..." autoFocus/>
          <button className="px-6 py-2 bg-gray-200 rounded-lg text-sm font-medium" onClick={()=>{setCardMappingTarget(null);showScanResult('success','âœ…',cardMappingTarget.name,'ì¶œì„ ì™„ë£Œ (ì¹´ë“œ ì—†ì´)')}}>ê±´ë„ˆë›°ê¸°</button>
        </div>
      </div>}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Completion
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function CompletionPage({training,participants,attendanceRecords,cards,showToast,showScanResult,loadParticipants,loadCards,loadAttendance}){
  const [qrInput,setQr]=useState('');
  const [target,setTarget]=useState(null);
  const [cardQr,setCardQr]=useState('');
  const [showManual,setShowManual]=useState(false);
  const [tab,setTab]=useState('completion');
  const [exitReason,setExitReason]=useState('ê°œì¸ì‚¬ì •');
  const [exitMemo,setExitMemo]=useState('');
  const [processing,setProcessing]=useState(false);
  const inputRef=useRef();
  const cardRef=useRef();

  useFocusLock(inputRef,!target&&!showManual);

  const totalSessions=training.days*2;
  const minSessions=Math.ceil(totalSessions*2/3);
  const getAttCount=(pid)=>attendanceRecords.filter(a=>a.participantId===pid).length;

  const resolveTarget=(code)=>{
    let t=participants.find(p=>p.qrCode===code);
    if(!t){const c=cards.find(c=>c.qrCode===code&&c.status==='mapped');if(c)t=participants.find(p=>p.id===c.participantId)}
    if(!t){showScanResult('error','âŒ','ë¯¸ë“±ë¡','ë“±ë¡ë˜ì§€ ì•Šì€ QR');setQr('');return}
    setTarget(t);setQr('');
    setTimeout(()=>cardRef.current?.focus(),50);
  };

  const processCompletion=async()=>{
    if(!target||processing)return;
    if(target.certificateIssued){showScanResult('duplicate','âš ï¸',target.name,'ì´ë¯¸ ìˆ˜ë£Œ ì²˜ë¦¬ë¨');reset();return}
    const attCount=getAttCount(target.id);
    const surveyOk=target.surveyCompleted;

    setProcessing(true);
    try{
      // Return card if scanned
      if(cardQr){
        await apiPost({action:'returnCard',cardId:cardQr});
      }
      if(surveyOk&&attCount>=minSessions){
        // Mark as completed â€” use markSurvey or a completion endpoint
        // For now we just rely on the card return and survey status
        showScanResult('success','ğŸ“',target.name,'ìˆ˜ë£Œ ì™„ë£Œ! ìˆ˜ë£Œì¦ ìƒì„± ê°€ëŠ¥');
        await Promise.all([loadParticipants(training.id),loadCards()]);
      }else{
        const reasons=[];
        if(!surveyOk)reasons.push('ì„¤ë¬¸ ë¯¸ì™„ë£Œ');
        if(attCount<minSessions)reasons.push(`ì¶œì„ ë¶€ì¡±(${attCount}/${totalSessions})`);
        showScanResult('error','âŒ',target.name,reasons.join(', '));
      }
    }catch(e){
      showToast('âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜','err');
    }finally{setProcessing(false);setTimeout(reset,1000)}
  };

  const processEarlyExit=async()=>{
    if(!target||processing)return;
    setProcessing(true);
    try{
      // Return card
      const pCard=cards.find(c=>c.participantId===target.id&&c.status==='mapped');
      if(pCard){
        await apiPost({action:'returnCard',cardId:pCard.qrCode});
      }
      showScanResult('success','ğŸšª',target.name,`ì¤‘ë„í‡´ì¥ (${exitReason})`);
      await loadCards();
    }catch(e){
      showToast('âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜','err');
    }finally{setProcessing(false);setTimeout(reset,1000)}
  };

  const toggleSurvey=async(pid)=>{
    try{
      await apiPost({action:'markSurvey',participantId:pid});
      await loadParticipants(training.id);
      showToast('âœ… ì„¤ë¬¸ ìƒíƒœ ë³€ê²½');
    }catch(e){showToast('âŒ ì˜¤ë¥˜','err')}
  };

  const generateCertificate=(p)=>{
    try{
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF('landscape','mm','a4');
      doc.setFontSize(36);doc.text('ìˆ˜ ë£Œ ì¦',148,60,{align:'center'});
      doc.setFontSize(20);doc.text(p.name,148,90,{align:'center'});
      doc.setFontSize(14);doc.text(`ì†Œì†: ${p.company}${p.position?' / '+p.position:''}`,148,110,{align:'center'});
      doc.text(`ì—°ìˆ˜: ${training.name}`,148,125,{align:'center'});
      doc.text(`ê¸°ê°„: ${training.startDate} ~ ${training.endDate}`,148,140,{align:'center'});
      doc.text(`ìœ„ ì‚¬ëŒì€ ë³¸ ì—°ìˆ˜ê³¼ì •ì„ ìˆ˜ë£Œí•˜ì˜€ìŒì„ ì¦ëª…í•©ë‹ˆë‹¤.`,148,165,{align:'center'});
      doc.text(new Date().toLocaleDateString('ko-KR'),148,185,{align:'center'});
      doc.text('ì½”ìŠ¤ë‹¥í˜‘íšŒì¥',148,200,{align:'center'});
      doc.save(`ìˆ˜ë£Œì¦_${p.name}.pdf`);
      showToast('ğŸ“„ ìˆ˜ë£Œì¦ PDF ìƒì„± ì™„ë£Œ');
    }catch(e){showToast('âŒ PDF ìƒì„± ì˜¤ë¥˜: '+e.message,'err')}
  };

  const reset=()=>{setTarget(null);setQr('');setCardQr('');setExitReason('ê°œì¸ì‚¬ì •');setExitMemo('')};

  const survDone=participants.filter(p=>p.surveyCompleted).length;
  const certDone=participants.filter(p=>p.certificateIssued).length;

  return(
    <div>
      <h1 className="text-2xl font-bold mb-5">ğŸ“ ìˆ˜ë£Œ ì²˜ë¦¬</h1>
      <div className="bg-yellow-50 border border-yellow-300 rounded-xl p-3 mb-4 text-sm">ğŸ“Œ <strong>ìˆ˜ë£Œ ì¡°ê±´:</strong> ì „ì²´ {totalSessions}ì„¸ì…˜ ì¤‘ {minSessions}ê°œ ì´ìƒ ì¶œì„ + ì„¤ë¬¸ ì™„ë£Œ</div>
      <div className="grid grid-cols-3 gap-3 mb-4">
        <StatCard title="ì„¤ë¬¸ ì™„ë£Œ" value={survDone} icon="ğŸ“" color="blue"/>
        <StatCard title="ìˆ˜ë£Œ ë°œê¸‰" value={certDone} icon="ğŸ“" color="green"/>
        <StatCard title="ì¹´ë“œ ë°˜ë‚©" value={cards.filter(c=>c.returnedAt&&participants.some(p=>p.id===c.participantId)).length} icon="ğŸ’³"/>
      </div>
      <div className="flex gap-2 mb-4 border-b pb-2">
        <button className={`px-4 py-2 font-semibold text-sm rounded-t ${tab==='completion'?'bg-blue-600 text-white':'border'}`} onClick={()=>{setTab('completion');reset()}}>ğŸ“ ìˆ˜ë£Œ ì²˜ë¦¬</button>
        <button className={`px-4 py-2 font-semibold text-sm rounded-t ${tab==='exit'?'bg-orange-500 text-white':'border'}`} onClick={()=>{setTab('exit');reset()}}>ğŸšª ì¤‘ë„í‡´ì¥</button>
      </div>
      <div className="grid md:grid-cols-2 gap-4">
        <div className="bg-white rounded-xl p-5 shadow-sm">
          {tab==='completion'?(
            !target?(
              <div>
                <h3 className="text-sm font-semibold text-gray-500 mb-3">ì°¸ê°€ì QR ìŠ¤ìº”</h3>
                <input ref={inputRef} type="text" className="scanner-input w-full px-4 py-3 border rounded-lg" value={qrInput} onChange={e=>setQr(e.target.value.trim())} onKeyDown={e=>{if(e.key==='Enter'&&qrInput)resolveTarget(qrInput)}} placeholder="ì°¸ê°€ì QR ìŠ¤ìº”..." autoFocus/>
                <div className="flex gap-2 mt-3">
                  <button className="px-3 py-1 border rounded text-xs" onClick={()=>setShowManual(true)}>ğŸ” ìˆ˜ë™ ê²€ìƒ‰</button>
                </div>
              </div>
            ):(
              <div>
                <div className="bg-gray-50 p-4 rounded-xl mb-4">
                  <div className="flex justify-between items-center">
                    <div><div className="text-xl font-bold">{target.name}</div><div className="text-sm text-gray-500">{target.company}</div></div>
                    <button className="px-3 py-1 border rounded text-xs" onClick={reset}>âœ• ì·¨ì†Œ</button>
                  </div>
                  <div className="mt-3 space-y-1 text-sm">
                    <div className={target.surveyCompleted?'text-green-600':'text-red-600 font-bold'}>{target.surveyCompleted?'âœ… ì„¤ë¬¸ ì™„ë£Œ':'âŒ ì„¤ë¬¸ ë¯¸ì™„ë£Œ'} {!target.surveyCompleted&&<button className="ml-2 px-2 py-0.5 bg-yellow-500 text-white rounded text-xs" onClick={()=>toggleSurvey(target.id)}>ìˆ˜ë™ ì™„ë£Œ</button>}</div>
                    <div className={getAttCount(target.id)>=minSessions?'text-green-600':'text-red-600 font-bold'}>{getAttCount(target.id)>=minSessions?'âœ…':'âŒ'} ì¶œì„ {getAttCount(target.id)}/{totalSessions} (ìµœì†Œ {minSessions})</div>
                  </div>
                </div>
                <div className="mb-4">
                  <h4 className="text-sm font-semibold mb-2">ğŸ’³ ì¹´ë“œ ë°˜ë‚© (ì¹´ë“œ QR ìŠ¤ìº”)</h4>
                  <input ref={cardRef} type="text" className="scanner-input w-full px-4 py-3 border rounded-lg" value={cardQr} onChange={e=>setCardQr(e.target.value.trim())} onKeyDown={e=>{if(e.key==='Enter')processCompletion()}} placeholder="ì¶œì…ì¹´ë“œ QR ìŠ¤ìº” (ë°˜ë‚©)..."/>
                </div>
                <button className="w-full px-6 py-4 bg-green-600 text-white text-lg rounded-xl font-bold hover:bg-green-700 disabled:opacity-50 flex items-center justify-center gap-2" onClick={processCompletion} disabled={processing}>
                  {processing?<><Spinner/> ì²˜ë¦¬ ì¤‘...</>:'ğŸ“ ìˆ˜ë£Œ ì²˜ë¦¬'}
                </button>
              </div>
            )
          ):(
            !target?(
              <div>
                <h3 className="text-sm font-semibold text-gray-500 mb-3">ğŸšª ì¤‘ë„í‡´ì¥ â€” QR ìŠ¤ìº”</h3>
                <div className="bg-orange-50 border border-orange-300 rounded-lg p-3 mb-3 text-sm">âš ï¸ ì¤‘ë„í‡´ì¥ìëŠ” <strong>ë¯¸ìˆ˜ë£Œ</strong> ì²˜ë¦¬ë©ë‹ˆë‹¤.</div>
                <input ref={inputRef} type="text" className="scanner-input w-full px-4 py-3 border rounded-lg" value={qrInput} onChange={e=>setQr(e.target.value.trim())} onKeyDown={e=>{if(e.key==='Enter'&&qrInput)resolveTarget(qrInput)}} placeholder="QR ìŠ¤ìº”..." autoFocus/>
                <button className="mt-3 px-3 py-1 border rounded text-xs" onClick={()=>setShowManual(true)}>ğŸ” ìˆ˜ë™ ê²€ìƒ‰</button>
              </div>
            ):(
              <div>
                <div className="bg-gray-50 p-4 rounded-xl mb-4">
                  <div className="flex justify-between"><div><div className="text-xl font-bold">{target.name}</div><div className="text-sm text-gray-500">{target.company}</div></div>
                    <button className="px-3 py-1 border rounded text-xs" onClick={reset}>âœ•</button></div>
                </div>
                <div className="mb-3"><label className="text-sm font-semibold block mb-1">í‡´ì¥ ì‚¬ìœ </label>
                  <select className="w-full px-3 py-2 border rounded-lg" value={exitReason} onChange={e=>setExitReason(e.target.value)}>
                    {['ê°œì¸ì‚¬ì •','ì—…ë¬´','ê±´ê°•','ê¸°íƒ€'].map(r=><option key={r}>{r}</option>)}
                  </select></div>
                <div className="mb-4"><label className="text-sm font-semibold block mb-1">ë©”ëª¨</label>
                  <textarea className="w-full px-3 py-2 border rounded-lg" value={exitMemo} onChange={e=>setExitMemo(e.target.value)} rows={2}/></div>
                <button className="w-full px-6 py-4 bg-red-600 text-white text-lg rounded-xl font-bold hover:bg-red-700 disabled:opacity-50" onClick={processEarlyExit} disabled={processing}>
                  {processing?'ì²˜ë¦¬ ì¤‘...':'ğŸšª ì¤‘ë„í‡´ì¥ ì²˜ë¦¬'}
                </button>
              </div>
            )
          )}
        </div>
        <div className="bg-white rounded-xl p-5 shadow-sm">
          <h3 className="text-sm font-semibold text-gray-500 mb-3">ì°¸ê°€ì í˜„í™©</h3>
          <div className="max-h-96 overflow-y-auto">
            <table className="w-full text-sm"><thead><tr className="text-xs text-gray-500 bg-gray-50"><th className="text-left p-2">ì´ë¦„</th><th className="p-2">ì„¤ë¬¸</th><th className="p-2">ìˆ˜ë£Œ</th><th className="p-2">ìˆ˜ë£Œì¦</th></tr></thead>
              <tbody>{participants.map(p=>(
                <tr key={p.id} className="border-t"><td className="p-2 font-semibold">{p.name}<br/><span className="text-xs text-gray-400">{p.company}</span></td>
                  <td className="p-2 text-center">{p.surveyCompleted?<span className="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">ì™„ë£Œ</span>:<span className="text-xs bg-gray-100 px-2 py-0.5 rounded-full cursor-pointer" onClick={()=>toggleSurvey(p.id)}>ë¯¸ì™„ë£Œ</span>}</td>
                  <td className="p-2 text-center">{p.certificateIssued?<span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">ìˆ˜ë£Œ</span>:<span className="text-xs bg-gray-100 px-2 py-0.5 rounded-full">ëŒ€ê¸°</span>}</td>
                  <td className="p-2 text-center">{p.certificateIssued&&<button className="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700" onClick={()=>generateCertificate(p)}>ğŸ“„ PDF</button>}</td></tr>
              ))}</tbody>
            </table>
          </div>
        </div>
      </div>
      {showManual&&<ManualSearch participants={participants} title={tab==='completion'?'ìˆ˜ë£Œ ëŒ€ìƒì':'ì¤‘ë„í‡´ì¥ ëŒ€ìƒì'} onClose={()=>setShowManual(false)} onSelect={p=>{setTarget(p);setShowManual(false)}}/>}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Records
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function RecordsPage({training,participants,attendanceRecords,cards,showToast,loadAttendance,loadParticipants}){
  const [search,setSearch]=useState('');
  const filtered=participants.filter(p=>p.name.includes(search)||p.company.includes(search)||(p.phone||'').includes(search));
  const dayArr=Array.from({length:training.days},(_,i)=>i+1);
  const totalSessions=training.days*2;

  // Load all attendance on mount
  useEffect(()=>{loadAttendance(training.id)},[]);

  const downloadExcel=()=>{
    const rows=filtered.map(p=>{
      const row={'ì´ë¦„':p.name,'íšŒì‚¬':p.company,'ì§ê¸‰':p.position||'','ì—°ë½ì²˜':p.phone||''};
      dayArr.forEach(d=>{
        const am=attendanceRecords.find(a=>a.participantId===p.id&&a.day===d&&a.session==='AM');
        const pm=attendanceRecords.find(a=>a.participantId===p.id&&a.day===d&&a.session==='PM');
        row[`${d}ì¼ì°¨ ì˜¤ì „`]=am?new Date(am.checkedAt).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):'';
        row[`${d}ì¼ì°¨ ì˜¤í›„`]=pm?new Date(pm.checkedAt).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):'';
      });
      const attCount=attendanceRecords.filter(a=>a.participantId===p.id).length;
      row['ì¶œì„ë¥ ']=`${totalSessions?Math.round(attCount/totalSessions*100):0}%`;
      const pCard=cards.find(c=>c.participantId===p.id&&c.status!=='available');
      row['ì¹´ë“œ']=pCard?pCard.status==='returned'?'ë°˜ë‚©':pCard.status==='lost'?'ë¶„ì‹¤':'ë³´ìœ ':'';
      row['ì¹´ë“œë²ˆí˜¸']=pCard?.qrCode||'';
      row['ì„¤ë¬¸']=p.surveyCompleted?'ì™„ë£Œ':'ë¯¸ì™„ë£Œ';
      row['ìˆ˜ë£Œ']=p.certificateIssued?'ë°œê¸‰':'ë¯¸ë°œê¸‰';
      return row;
    });
    const ws=XLSX.utils.json_to_sheet(rows);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'ì¶œì„ë¶€');
    XLSX.writeFile(wb,`ì¶œì„ë¶€_${training.name}_${new Date().toISOString().slice(0,10)}.xlsx`);
    showToast('ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
  };

  return(
    <div>
      <h1 className="text-2xl font-bold mb-5">ğŸ“‹ ì¶œì„ë¶€ ì¡°íšŒ â€” {training.name}</h1>
      <div className="bg-white rounded-xl p-4 mb-4 shadow-sm flex flex-wrap gap-3 items-center">
        <input type="search" className="flex-1 min-w-48 px-4 py-2 border rounded-lg" placeholder="ğŸ” ì´ë¦„, ì†Œì†ì‚¬ ê²€ìƒ‰..." value={search} onChange={e=>setSearch(e.target.value)}/>
        <button className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold" onClick={downloadExcel}>ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        <button className="px-4 py-2 border rounded-lg text-sm font-semibold hover:bg-gray-50" onClick={()=>Promise.all([loadAttendance(training.id),loadParticipants(training.id)]).then(()=>showToast('ğŸ”„ ìƒˆë¡œê³ ì¹¨'))}>ğŸ”„</button>
      </div>
      <div className="bg-white rounded-xl shadow-sm overflow-x-auto">
        <table className="w-full text-sm"><thead><tr className="text-xs text-gray-500 uppercase bg-gray-50">
          <th className="text-left p-2">#</th><th className="text-left p-2">ì´ë¦„</th><th className="text-left p-2">ì†Œì†</th>
          {dayArr.map(d=>[<th key={`${d}a`} className="p-2">{d}ì¼ ì˜¤ì „</th>,<th key={`${d}p`} className="p-2">{d}ì¼ ì˜¤í›„</th>])}
          <th className="p-2">ì¶œì„ë¥ </th><th className="p-2">ì¹´ë“œ</th><th className="p-2">ì„¤ë¬¸</th><th className="p-2">ìˆ˜ë£Œ</th>
        </tr></thead>
          <tbody>{filtered.map((p,i)=>{
            const attCount=attendanceRecords.filter(a=>a.participantId===p.id).length;
            const rate=totalSessions?Math.round(attCount/totalSessions*100):0;
            const pCard=cards.find(c=>c.participantId===p.id&&c.status!=='available');
            return(
              <tr key={p.id} className="border-t hover:bg-gray-50">
                <td className="p-2">{i+1}</td><td className="p-2 font-semibold">{p.name}</td><td className="p-2 text-xs text-gray-500">{p.company}</td>
                {dayArr.map(d=>{
                  const am=attendanceRecords.find(a=>a.participantId===p.id&&a.day===d&&a.session==='AM');
                  const pm=attendanceRecords.find(a=>a.participantId===p.id&&a.day===d&&a.session==='PM');
                  return[
                    <td key={`${d}A`} className="p-2 text-center"><span className={`inline-flex items-center justify-center w-7 h-7 rounded-full text-xs font-bold ${am?'bg-green-100 text-green-800':'bg-gray-100 text-gray-300'}`}>{am?'âœ“':'Â·'}</span></td>,
                    <td key={`${d}P`} className="p-2 text-center"><span className={`inline-flex items-center justify-center w-7 h-7 rounded-full text-xs font-bold ${pm?'bg-green-100 text-green-800':'bg-gray-100 text-gray-300'}`}>{pm?'âœ“':'Â·'}</span></td>,
                  ];
                })}
                <td className="p-2 text-center"><span className={`text-xs px-2 py-0.5 rounded-full font-semibold ${rate>=80?'bg-green-100 text-green-800':rate>=50?'bg-yellow-100 text-yellow-800':'bg-red-100 text-red-800'}`}>{rate}%</span></td>
                <td className="p-2 text-center">{pCard?(<div><span className={`text-xs px-2 py-0.5 rounded-full ${pCard.status==='returned'?'bg-green-100 text-green-800':pCard.status==='lost'?'bg-red-100 text-red-800':'bg-yellow-100 text-yellow-800'}`}>{pCard.status==='returned'?'ë°˜ë‚©':pCard.status==='lost'?'ë¶„ì‹¤':'ë³´ìœ '}</span><div className="text-[10px] text-gray-400 mt-0.5">{pCard.qrCode?.replace('KOSDAQ-','')}</div></div>):'-'}</td>
                <td className="p-2 text-center">{p.surveyCompleted?<span className="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full">âœ“</span>:'-'}</td>
                <td className="p-2 text-center">{p.certificateIssued?<span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">ë°œê¸‰</span>:'-'}</td>
              </tr>
            );
          })}</tbody>
        </table>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
